<UserControl x:Class="Lazarus.Desktop.Views.ControlNetsView"
			 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:local="clr-namespace:Lazarus.Desktop.Views"
			 mc:Ignorable="d"
			 Background="{DynamicResource PrimaryDarkBrush}">

	<UserControl.Resources>
		<!-- ControlNet Card Template -->
		<DataTemplate x:Key="ControlNetCardTemplate">
			<Border MinWidth="220"
					MaxWidth="280"
					Margin="0,0,12,12">
				<Border.Style>
					<Style TargetType="Border"
						   BasedOn="{StaticResource DarkCardStyle}">
						<Style.Triggers>
							<DataTrigger Binding="{Binding IsLoaded}"
										 Value="True">
								<Setter Property="BorderBrush"
										Value="{DynamicResource AccentRedBrush}"/>
								<Setter Property="BorderThickness"
										Value="2"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Border.Style>

				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
					</Grid.RowDefinitions>

					<!-- Type Icon and Badge -->
					<Border Grid.Row="0"
							Height="80"
							Background="{DynamicResource TertiaryDarkBrush}"
							CornerRadius="4"
							Margin="0,0,0,8">
						<Grid>
							<TextBlock Text="🎛️"
									   FontSize="32"
									   HorizontalAlignment="Center"
									   VerticalAlignment="Center"
									   Foreground="{DynamicResource AccentRedBrush}"/>
							<Border Background="{DynamicResource AccentRedBrush}"
									CornerRadius="8"
									Padding="8,4"
									HorizontalAlignment="Right"
									VerticalAlignment="Top"
									Margin="0,4,4,0">
								<TextBlock Text="{Binding Type}"
										   Style="{StaticResource CaptionTextStyle}"
										   Foreground="{DynamicResource ButtonTextBrush}"
										   FontSize="10"
										   FontWeight="Bold"/>
							</Border>
						</Grid>
					</Border>

					<!-- Name and Version -->
					<StackPanel Grid.Row="1"
								Margin="0,0,0,8">
						<TextBlock Text="{Binding Name}"
								   Style="{StaticResource BodyTextStyle}"
								   FontWeight="SemiBold"
								   FontSize="13"
								   TextTrimming="CharacterEllipsis"/>
						<TextBlock Text="{Binding Version}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="10"
								   Margin="0,2,0,0"/>
					</StackPanel>

					<!-- Description -->
					<TextBlock Grid.Row="2"
							   Text="{Binding Description}"
							   Style="{StaticResource CaptionTextStyle}"
							   FontSize="11"
							   TextWrapping="Wrap"
							   MaxHeight="50"
							   Margin="0,0,0,8"/>

					<!-- Metadata -->
					<StackPanel Grid.Row="3"
								Margin="0,0,0,8">
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Grid.Column="0"
									   Text="{Binding FileSize}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
							<TextBlock Grid.Column="1"
									   Text="{Binding DefaultWeight, StringFormat=w: {0:F1}}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   HorizontalAlignment="Right"/>
						</Grid>
					</StackPanel>

					<!-- Load Button -->
					<Button Grid.Row="4"
							Command="{Binding DataContext.ApplyControlNetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
							CommandParameter="{Binding}"
							Padding="8,8"
							FontSize="11">
						<Button.Style>
							<Style TargetType="Button"
								   BasedOn="{StaticResource PrimaryButtonStyle}">
								<Setter Property="Content"
										Value="Apply"/>
								<Style.Triggers>
									<DataTrigger Binding="{Binding IsLoaded}"
												 Value="True">
										<Setter Property="Background"
												Value="{DynamicResource SuccessBrush}"/>
										<Setter Property="Foreground"
												Value="{DynamicResource ButtonTextBrush}"/>
										<Setter Property="Content"
												Value="✓ Applied"/>
									</DataTrigger>
								</Style.Triggers>
							</Style>
						</Button.Style>
					</Button>
				</Grid>
			</Border>
		</DataTemplate>

		<!-- Applied ControlNet Template -->
		<DataTemplate x:Key="AppliedControlNetTemplate">
			<Border Style="{StaticResource DarkCardStyle}"
					Padding="16,12"
					Margin="0,0,0,8"
					BorderBrush="{DynamicResource AccentRedBrush}"
					BorderThickness="1">
				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
					</Grid.RowDefinitions>

					<!-- Header Row -->
					<Grid Grid.Row="0"
						  Margin="0,0,0,12">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="Auto"/>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<!-- Order Badge -->
						<Border Grid.Column="0"
								Background="{DynamicResource BorderBrush}"
								CornerRadius="12"
								Width="24"
								Height="24"
								VerticalAlignment="Center">
							<TextBlock Text="{Binding Order}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="11"
									   FontWeight="Bold"
									   HorizontalAlignment="Center"
									   VerticalAlignment="Center"/>
						</Border>

						<!-- Name and Type -->
						<StackPanel Grid.Column="1"
									Margin="12,0,0,0"
									VerticalAlignment="Center">
							<TextBlock Text="{Binding Name}"
									   Style="{StaticResource BodyTextStyle}"
									   FontWeight="Medium"
									   FontSize="13"/>
							<TextBlock Text="{Binding Type}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
						</StackPanel>

						<!-- Enable Toggle -->
						<CheckBox Grid.Column="2"
								  IsChecked="{Binding IsEnabled}"
								  Style="{StaticResource DarkCheckBoxStyle}"
								  VerticalAlignment="Center"
								  Margin="0,0,12,0"/>

						<!-- Remove Button -->
						<Button Grid.Column="3"
								Content="✕"
								Command="{Binding DataContext.RemoveControlNetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
								CommandParameter="{Binding}"
								Style="{StaticResource DangerButtonStyle}"
								Padding="10,6"
								FontSize="11"/>
					</Grid>

					<!-- Controls Row -->
					<Grid Grid.Row="1"
						  Margin="0,0,0,12">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
						</Grid.ColumnDefinitions>

						<!-- Weight Control -->
						<StackPanel Grid.Column="0"
									Margin="0,0,8,0">
							<TextBlock Text="Weight"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   Margin="0,0,0,4"/>
							<Grid>
								<Grid.RowDefinitions>
									<RowDefinition Height="Auto"/>
									<RowDefinition Height="Auto"/>
								</Grid.RowDefinitions>
								<TextBlock Grid.Row="0"
										   Text="{Binding Weight, StringFormat=F2}"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="10"
										   HorizontalAlignment="Center"/>
								<Slider Grid.Row="1"
										Value="{Binding Weight}"
										Minimum="0.0"
										Maximum="2.0"
										TickFrequency="0.1"
										Height="16"
										Foreground="{DynamicResource AccentRedBrush}"/>
							</Grid>
						</StackPanel>

						<!-- Guidance Start -->
						<StackPanel Grid.Column="1"
									Margin="4,0">
							<TextBlock Text="Start"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   Margin="0,0,0,4"/>
							<Grid>
								<Grid.RowDefinitions>
									<RowDefinition Height="Auto"/>
									<RowDefinition Height="Auto"/>
								</Grid.RowDefinitions>
								<TextBlock Grid.Row="0"
										   Text="{Binding GuidanceStart, StringFormat=F2}"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="10"
										   HorizontalAlignment="Center"/>
								<Slider Grid.Row="1"
										Value="{Binding GuidanceStart}"
										Minimum="0.0"
										Maximum="1.0"
										TickFrequency="0.05"
										Height="16"
										Foreground="{DynamicResource AccentRedBrush}"/>
							</Grid>
						</StackPanel>

						<!-- Guidance End -->
						<StackPanel Grid.Column="2"
									Margin="8,0,0,0">
							<TextBlock Text="End"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   Margin="0,0,0,4"/>
							<Grid>
								<Grid.RowDefinitions>
									<RowDefinition Height="Auto"/>
									<RowDefinition Height="Auto"/>
								</Grid.RowDefinitions>
								<TextBlock Grid.Row="0"
										   Text="{Binding GuidanceEnd, StringFormat=F2}"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="10"
										   HorizontalAlignment="Center"/>
								<Slider Grid.Row="1"
										Value="{Binding GuidanceEnd}"
										Minimum="0.0"
										Maximum="1.0"
										TickFrequency="0.05"
										Height="16"
										Foreground="{DynamicResource AccentRedBrush}"/>
							</Grid>
						</StackPanel>
					</Grid>

					<!-- Preprocessor and Image Row -->
					<Grid Grid.Row="2">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<!-- Preprocessor Type -->
						<StackPanel Grid.Column="0"
									Margin="0,0,8,0">
							<TextBlock Text="Preprocessor"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   Margin="0,0,0,4"/>
							<TextBlock Text="{Binding PreprocessorType}"
									   Style="{StaticResource BodyTextStyle}"
									   FontSize="12"/>
						</StackPanel>

						<!-- Input Image Status -->
						<StackPanel Grid.Column="1"
									VerticalAlignment="Center">
							<TextBlock Text="📷"
									   FontSize="16"
									   Foreground="{DynamicResource AccentRedBrush}"
									   HorizontalAlignment="Center"
									   Visibility="{Binding InputImagePath, Converter={StaticResource StringToBoolConverter}}"/>
						</StackPanel>
					</Grid>
				</Grid>
			</Border>
		</DataTemplate>
	</UserControl.Resources>

	<!-- New mode-aware host using global ViewMode templates -->
	<ContentControl Content="{Binding}">
		<ContentControl.ContentTemplateSelector>
			<StaticResource ResourceKey="ViewModeTemplateSelector"/>
		</ContentControl.ContentTemplateSelector>
	</ContentControl>

</UserControl>