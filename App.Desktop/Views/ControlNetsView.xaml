<UserControl x:Class="Lazarus.Desktop.Views.ControlNetsView"
			 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:local="clr-namespace:Lazarus.Desktop.Views"
			 mc:Ignorable="d"
			 Background="{StaticResource PrimaryDarkBrush}">

	<UserControl.Resources>
		<!-- ControlNet Card Template -->
		<DataTemplate x:Key="ControlNetCardTemplate">
			<Border MinWidth="220"
					MaxWidth="280"
					Margin="0,0,12,12">
				<Border.Style>
					<Style TargetType="Border"
						   BasedOn="{StaticResource DarkCardStyle}">
						<Style.Triggers>
							<DataTrigger Binding="{Binding IsLoaded}"
										 Value="True">
								<Setter Property="BorderBrush"
										Value="{StaticResource AccentPurpleBrush}"/>
								<Setter Property="BorderThickness"
										Value="2"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Border.Style>

				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
					</Grid.RowDefinitions>

					<!-- Type Icon and Badge -->
					<Border Grid.Row="0"
							Height="80"
							Background="{StaticResource TertiaryDarkBrush}"
							CornerRadius="4"
							Margin="0,0,0,8">
						<Grid>
							<TextBlock Text="🎛️"
									   FontSize="32"
									   HorizontalAlignment="Center"
									   VerticalAlignment="Center"
									   Foreground="{StaticResource AccentPurpleBrush}"/>
							<Border Background="{StaticResource AccentPurpleBrush}"
									CornerRadius="8"
									Padding="4,2"
									HorizontalAlignment="Right"
									VerticalAlignment="Top"
									Margin="0,4,4,0">
								<TextBlock Text="{Binding Type}"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="9"
										   FontWeight="Bold"/>
							</Border>
						</Grid>
					</Border>

					<!-- Name and Version -->
					<StackPanel Grid.Row="1"
								Margin="0,0,0,8">
						<TextBlock Text="{Binding Name}"
								   Style="{StaticResource BodyTextStyle}"
								   FontWeight="SemiBold"
								   FontSize="13"
								   TextTrimming="CharacterEllipsis"/>
						<TextBlock Text="{Binding Version}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="10"
								   Margin="0,2,0,0"/>
					</StackPanel>

					<!-- Description -->
					<TextBlock Grid.Row="2"
							   Text="{Binding Description}"
							   Style="{StaticResource CaptionTextStyle}"
							   FontSize="11"
							   TextWrapping="Wrap"
							   MaxHeight="50"
							   Margin="0,0,0,8"/>

					<!-- Metadata -->
					<StackPanel Grid.Row="3"
								Margin="0,0,0,8">
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Grid.Column="0"
									   Text="{Binding FileSize}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
							<TextBlock Grid.Column="1"
									   Text="{Binding DefaultWeight, StringFormat=w: {0:F1}}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   HorizontalAlignment="Right"/>
						</Grid>
					</StackPanel>

					<!-- Load Button -->
					<Button Grid.Row="4"
							Command="{Binding DataContext.ApplyControlNetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
							CommandParameter="{Binding}"
							Padding="0,6"
							FontSize="11">
						<Button.Style>
							<Style TargetType="Button"
								   BasedOn="{StaticResource PrimaryButtonStyle}">
								<Setter Property="Content"
										Value="Apply"/>
								<Style.Triggers>
									<DataTrigger Binding="{Binding IsLoaded}"
												 Value="True">
										<Setter Property="Background"
												Value="{StaticResource SuccessBrush}"/>
										<Setter Property="Content"
												Value="✓ Applied"/>
									</DataTrigger>
								</Style.Triggers>
							</Style>
						</Button.Style>
					</Button>
				</Grid>
			</Border>
		</DataTemplate>

		<!-- Applied ControlNet Template -->
		<DataTemplate x:Key="AppliedControlNetTemplate">
			<Border Style="{StaticResource DarkCardStyle}"
					Padding="16,12"
					Margin="0,0,0,8"
					BorderBrush="{StaticResource AccentPurpleBrush}"
					BorderThickness="1">
				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
					</Grid.RowDefinitions>

					<!-- Header Row -->
					<Grid Grid.Row="0"
						  Margin="0,0,0,12">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="Auto"/>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<!-- Order Badge -->
						<Border Grid.Column="0"
								Background="{StaticResource BorderBrush}"
								CornerRadius="12"
								Width="24"
								Height="24"
								VerticalAlignment="Center">
							<TextBlock Text="{Binding Order}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="11"
									   FontWeight="Bold"
									   HorizontalAlignment="Center"
									   VerticalAlignment="Center"/>
						</Border>

						<!-- Name and Type -->
						<StackPanel Grid.Column="1"
									Margin="12,0,0,0"
									VerticalAlignment="Center">
							<TextBlock Text="{Binding Name}"
									   Style="{StaticResource BodyTextStyle}"
									   FontWeight="Medium"
									   FontSize="13"/>
							<TextBlock Text="{Binding Type}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
						</StackPanel>

						<!-- Enable Toggle -->
						<CheckBox Grid.Column="2"
								  IsChecked="{Binding IsEnabled}"
								  Style="{StaticResource DarkCheckBoxStyle}"
								  VerticalAlignment="Center"
								  Margin="0,0,12,0"/>

						<!-- Remove Button -->
						<Button Grid.Column="3"
								Content="✕"
								Command="{Binding DataContext.RemoveControlNetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
								CommandParameter="{Binding}"
								Style="{StaticResource DangerButtonStyle}"
								Padding="6,4"
								FontSize="11"/>
					</Grid>

					<!-- Controls Row -->
					<Grid Grid.Row="1"
						  Margin="0,0,0,12">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
						</Grid.ColumnDefinitions>

						<!-- Weight Control -->
						<StackPanel Grid.Column="0"
									Margin="0,0,8,0">
							<TextBlock Text="Weight"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   Margin="0,0,0,4"/>
							<Grid>
								<Grid.RowDefinitions>
									<RowDefinition Height="Auto"/>
									<RowDefinition Height="Auto"/>
								</Grid.RowDefinitions>
								<TextBlock Grid.Row="0"
										   Text="{Binding Weight, StringFormat=F2}"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="10"
										   HorizontalAlignment="Center"/>
								<Slider Grid.Row="1"
										Value="{Binding Weight}"
										Minimum="0.0"
										Maximum="2.0"
										TickFrequency="0.1"
										Height="16"
										Foreground="{StaticResource AccentPurpleBrush}"/>
							</Grid>
						</StackPanel>

						<!-- Guidance Start -->
						<StackPanel Grid.Column="1"
									Margin="4,0">
							<TextBlock Text="Start"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   Margin="0,0,0,4"/>
							<Grid>
								<Grid.RowDefinitions>
									<RowDefinition Height="Auto"/>
									<RowDefinition Height="Auto"/>
								</Grid.RowDefinitions>
								<TextBlock Grid.Row="0"
										   Text="{Binding GuidanceStart, StringFormat=F2}"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="10"
										   HorizontalAlignment="Center"/>
								<Slider Grid.Row="1"
										Value="{Binding GuidanceStart}"
										Minimum="0.0"
										Maximum="1.0"
										TickFrequency="0.05"
										Height="16"
										Foreground="{StaticResource AccentPurpleBrush}"/>
							</Grid>
						</StackPanel>

						<!-- Guidance End -->
						<StackPanel Grid.Column="2"
									Margin="8,0,0,0">
							<TextBlock Text="End"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   Margin="0,0,0,4"/>
							<Grid>
								<Grid.RowDefinitions>
									<RowDefinition Height="Auto"/>
									<RowDefinition Height="Auto"/>
								</Grid.RowDefinitions>
								<TextBlock Grid.Row="0"
										   Text="{Binding GuidanceEnd, StringFormat=F2}"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="10"
										   HorizontalAlignment="Center"/>
								<Slider Grid.Row="1"
										Value="{Binding GuidanceEnd}"
										Minimum="0.0"
										Maximum="1.0"
										TickFrequency="0.05"
										Height="16"
										Foreground="{StaticResource AccentPurpleBrush}"/>
							</Grid>
						</StackPanel>
					</Grid>

					<!-- Preprocessor and Image Row -->
					<Grid Grid.Row="2">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<!-- Preprocessor Type -->
						<StackPanel Grid.Column="0"
									Margin="0,0,8,0">
							<TextBlock Text="Preprocessor"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   Margin="0,0,0,4"/>
							<TextBlock Text="{Binding PreprocessorType}"
									   Style="{StaticResource BodyTextStyle}"
									   FontSize="12"/>
						</StackPanel>

						<!-- Input Image Status -->
						<StackPanel Grid.Column="1"
									VerticalAlignment="Center">
							<TextBlock Text="📷"
									   FontSize="16"
									   Foreground="{StaticResource AccentPurpleBrush}"
									   HorizontalAlignment="Center"
									   Visibility="{Binding InputImagePath, Converter={StaticResource StringToBoolConverter}}"/>
						</StackPanel>
					</Grid>
				</Grid>
			</Border>
		</DataTemplate>
	</UserControl.Resources>

	<Grid>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="2*"/>
			<ColumnDefinition Width="1*"/>
		</Grid.ColumnDefinitions>

		<!-- Left: Available ControlNets -->
		<Border Grid.Column="0"
				Style="{StaticResource DarkBorderStyle}"
				Margin="0,0,8,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="ControlNet Models"
							   Style="{StaticResource HeadingMediumStyle}"/>

					<Button Content="🔄"
							Command="{Binding RefreshCommand}"
							Style="{StaticResource SecondaryButtonStyle}"
							Padding="8,4"
							ToolTip="Refresh Models"/>
				</Grid>

				<!-- Configuration Panel -->
				<Border Grid.Row="1"
						Background="{StaticResource TertiaryDarkBrush}"
						CornerRadius="6"
						Padding="16,12"
						Margin="0,0,0,16">
					<Grid>
						<Grid.RowDefinitions>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="Auto"/>
						</Grid.RowDefinitions>

						<!-- Input Image -->
						<Grid Grid.Row="0"
							  Margin="0,0,0,12">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>

							<TextBox Text="{Binding InputImagePath}"
									 Style="{StaticResource DarkTextBoxStyle}"
									 IsReadOnly="True"
									 Margin="0,0,8,0"/>

							<Button Grid.Column="1"
									Content="Browse"
									Command="{Binding SelectInputImageCommand}"
									Style="{StaticResource SecondaryButtonStyle}"
									Padding="12,6"/>
						</Grid>

						<!-- Configuration Controls Row 1 -->
						<Grid Grid.Row="1"
							  Margin="0,0,0,12">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>

							<!-- Preprocessor Selection -->
							<StackPanel Grid.Column="0"
										Margin="0,0,8,0">
								<TextBlock Text="Preprocessor"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="11"
										   Margin="0,0,0,4"/>
								<ComboBox ItemsSource="{Binding PreprocessorTypes}"
										  SelectedItem="{Binding PreprocessorType}"
										  Background="#374151"
										  Foreground="White"
										  BorderBrush="#4b5563"
										  BorderThickness="1"
										  Padding="8,6">
									<ComboBox.Resources>
										<Style TargetType="ComboBoxItem">
											<Setter Property="Background"
													Value="Transparent"/>
											<Setter Property="Foreground"
													Value="White"/>
											<Setter Property="Padding"
													Value="8,6"/>
											<Style.Triggers>
												<Trigger Property="IsMouseOver"
														 Value="True">
													<Setter Property="Background"
															Value="#8b5cf6"/>
												</Trigger>
												<Trigger Property="IsSelected"
														 Value="True">
													<Setter Property="Background"
															Value="#7c3aed"/>
												</Trigger>
											</Style.Triggers>
										</Style>
									</ComboBox.Resources>
								</ComboBox>
							</StackPanel>

							<!-- Weight -->
							<StackPanel Grid.Column="1"
										Margin="8,0,0,0">
								<TextBlock Text="Weight"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="11"
										   Margin="0,0,0,4"/>
								<Grid>
									<Grid.RowDefinitions>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
									</Grid.RowDefinitions>
									<TextBlock Grid.Row="0"
											   Text="{Binding Weight, StringFormat=F2}"
											   Style="{StaticResource CaptionTextStyle}"
											   FontSize="10"
											   HorizontalAlignment="Center"/>
									<Slider Grid.Row="1"
											Value="{Binding Weight}"
											Minimum="0.0"
											Maximum="2.0"
											TickFrequency="0.1"
											Height="16"
											Foreground="{StaticResource AccentPurpleBrush}"/>
								</Grid>
							</StackPanel>
						</Grid>

						<!-- Configuration Controls Row 2 -->
						<Grid Grid.Row="2">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>

							<!-- Guidance Start -->
							<StackPanel Grid.Column="0"
										Margin="0,0,8,0">
								<TextBlock Text="Guidance Start"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="11"
										   Margin="0,0,0,4"/>
								<Grid>
									<Grid.RowDefinitions>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
									</Grid.RowDefinitions>
									<TextBlock Grid.Row="0"
											   Text="{Binding GuidanceStart, StringFormat=F2}"
											   Style="{StaticResource CaptionTextStyle}"
											   FontSize="10"
											   HorizontalAlignment="Center"/>
									<Slider Grid.Row="1"
											Value="{Binding GuidanceStart}"
											Minimum="0.0"
											Maximum="1.0"
											TickFrequency="0.05"
											Height="16"
											Foreground="{StaticResource AccentPurpleBrush}"/>
								</Grid>
							</StackPanel>

							<!-- Guidance End -->
							<StackPanel Grid.Column="1"
										Margin="8,0">
								<TextBlock Text="Guidance End"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="11"
										   Margin="0,0,0,4"/>
								<Grid>
									<Grid.RowDefinitions>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
									</Grid.RowDefinitions>
									<TextBlock Grid.Row="0"
											   Text="{Binding GuidanceEnd, StringFormat=F2}"
											   Style="{StaticResource CaptionTextStyle}"
											   FontSize="10"
											   HorizontalAlignment="Center"/>
									<Slider Grid.Row="1"
											Value="{Binding GuidanceEnd}"
											Minimum="0.0"
											Maximum="1.0"
											TickFrequency="0.05"
											Height="16"
											Foreground="{StaticResource AccentPurpleBrush}"/>
								</Grid>
							</StackPanel>

							<!-- Enable Toggle -->
							<CheckBox Grid.Column="2"
									  IsChecked="{Binding IsEnabled}"
									  Style="{StaticResource DarkCheckBoxStyle}"
									  Content="Enable"
									  VerticalAlignment="Bottom"
									  Margin="8,0,0,0"/>
						</Grid>
					</Grid>
				</Border>

				<!-- ControlNet Grid -->
				<ScrollViewer Grid.Row="2"
							  VerticalScrollBarVisibility="Auto">
					<ItemsControl ItemsSource="{Binding AvailableControlNets}"
								  ItemTemplate="{StaticResource ControlNetCardTemplate}">
						<ItemsControl.ItemsPanel>
							<ItemsPanelTemplate>
								<WrapPanel Orientation="Horizontal"/>
							</ItemsPanelTemplate>
						</ItemsControl.ItemsPanel>
					</ItemsControl>
				</ScrollViewer>

				<!-- Status -->
				<Grid Grid.Row="3"
					  Margin="0,16,0,0">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Grid.Column="0"
							   Text="{Binding StatusText}"
							   Foreground="{StaticResource SuccessBrush}"
							   FontSize="12"
							   VerticalAlignment="Center"/>

					<!-- Loading indicator -->
					<StackPanel Grid.Column="1"
								Orientation="Horizontal"
								Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
						<TextBlock Text="Loading..."
								   Style="{StaticResource CaptionTextStyle}"
								   Margin="0,0,8,0"/>
						<Border Background="{StaticResource AccentPurpleBrush}"
								Width="12"
								Height="12"
								CornerRadius="6">
							<Border.RenderTransform>
								<RotateTransform x:Name="LoadingSpinner"/>
							</Border.RenderTransform>
							<Border.Triggers>
								<EventTrigger RoutedEvent="Border.Loaded">
									<BeginStoryboard>
										<Storyboard RepeatBehavior="Forever">
											<DoubleAnimation Storyboard.TargetName="LoadingSpinner"
															 Storyboard.TargetProperty="Angle"
															 From="0"
															 To="360"
															 Duration="0:0:1"/>
										</Storyboard>
									</BeginStoryboard>
								</EventTrigger>
							</Border.Triggers>
						</Border>
					</StackPanel>
				</Grid>
			</Grid>
		</Border>

		<!-- Right: Applied ControlNets Stack -->
		<Border Grid.Column="1"
				Style="{StaticResource DarkBorderStyle}"
				Margin="8,0,0,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="Applied Stack"
							   Style="{StaticResource HeadingMediumStyle}"/>

					<Button Content="Clear All"
							Command="{Binding ClearAllControlNetsCommand}"
							Style="{StaticResource DangerButtonStyle}"
							Padding="8,4"
							FontSize="11"/>
				</Grid>

				<!-- Applied ControlNets List -->
				<ScrollViewer Grid.Row="1"
							  VerticalScrollBarVisibility="Auto">
					<StackPanel>
						<ItemsControl ItemsSource="{Binding AppliedControlNets}"
									  ItemTemplate="{StaticResource AppliedControlNetTemplate}"/>

						<!-- Empty State -->
						<Border Background="{StaticResource TertiaryDarkBrush}"
								CornerRadius="6"
								Padding="20"
								Visibility="{Binding AppliedControlNetsCount, Converter={StaticResource ZeroToVisibilityConverter}}">
							<StackPanel HorizontalAlignment="Center">
								<TextBlock Text="🎛️"
										   FontSize="32"
										   HorizontalAlignment="Center"
										   Foreground="{StaticResource TextDisabledBrush}"
										   Margin="0,0,0,8"/>
								<TextBlock Text="No ControlNets Applied"
										   HorizontalAlignment="Center"
										   Style="{StaticResource BodyTextStyle}"
										   FontSize="13"
										   FontWeight="Medium"/>
								<TextBlock Text="Configure settings above and apply ControlNet models"
										   HorizontalAlignment="Center"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="11"
										   TextWrapping="Wrap"
										   TextAlignment="Center"
										   Margin="0,4,0,0"/>
							</StackPanel>
						</Border>
					</StackPanel>
				</ScrollViewer>

				<!-- Summary -->
				<Border Grid.Row="2"
						Background="{StaticResource TertiaryDarkBrush}"
						CornerRadius="6"
						Padding="12,8"
						Margin="0,16,0,0">
					<Grid>
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
						</Grid.ColumnDefinitions>

						<StackPanel Grid.Column="0">
							<TextBlock Text="Active Models"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
							<TextBlock Text="{Binding AppliedControlNetsCount}"
									   Style="{StaticResource HeadingMediumStyle}"
									   FontSize="16"/>
						</StackPanel>

						<StackPanel Grid.Column="1">
							<TextBlock Text="Processing"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
							<TextBlock Text="Ready"
									   Style="{StaticResource HeadingMediumStyle}"
									   FontSize="16"/>
						</StackPanel>
					</Grid>
				</Border>
			</Grid>
		</Border>
	</Grid>
</UserControl>