<UserControl x:Class="Lazarus.Desktop.Views.LorAsView"
			 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 mc:Ignorable="d"
			 Background="#0f0f0f">

	<UserControl.Resources>
		<!-- LoRA Card Template -->
		<DataTemplate x:Key="LoRACardTemplate">
			<Border Background="#1e1e1e"
					CornerRadius="8"
					Padding="12"
					Margin="0,0,12,12"
					BorderBrush="#333333"
					BorderThickness="1"
					MinWidth="200"
					MaxWidth="250">
				<Border.Style>
					<Style TargetType="Border">
						<Style.Triggers>
							<DataTrigger Binding="{Binding IsLoaded}"
										 Value="True">
								<Setter Property="BorderBrush"
										Value="#8b5cf6"/>
								<Setter Property="BorderThickness"
										Value="2"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Border.Style>

				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
					</Grid.RowDefinitions>

					<!-- Preview Image -->
					<Border Grid.Row="0"
							Height="120"
							Background="#2d3748"
							CornerRadius="4"
							Margin="0,0,0,8">
						<Grid>
							<Image Source="{Binding PreviewImagePath}"
								   Stretch="UniformToFill"
								   Visibility="{Binding PreviewImagePath, Converter={StaticResource StringToVisibilityConverter}}"/>
							<TextBlock Text="ðŸ“·"
									   FontSize="32"
									   Foreground="#64748b"
									   HorizontalAlignment="Center"
									   VerticalAlignment="Center"
									   Visibility="{Binding PreviewImagePath, Converter={StaticResource InverseStringToVisibilityConverter}}"/>
						</Grid>
					</Border>

					<!-- Name and Category -->
					<StackPanel Grid.Row="1"
								Margin="0,0,0,8">
						<TextBlock Text="{Binding Name}"
								   Foreground="#e2e8f0"
								   FontWeight="SemiBold"
								   FontSize="13"
								   TextTrimming="CharacterEllipsis"/>
						<Border Background="#374151"
								CornerRadius="12"
								Padding="6,2"
								HorizontalAlignment="Left"
								Margin="0,4,0,0">
							<TextBlock Text="{Binding Category}"
									   Foreground="#94a3b8"
									   FontSize="10"/>
						</Border>
					</StackPanel>

					<!-- Description -->
					<TextBlock Grid.Row="2"
							   Text="{Binding ShortDescription}"
							   Foreground="#94a3b8"
							   FontSize="11"
							   TextWrapping="Wrap"
							   MaxHeight="40"
							   Margin="0,0,0,8"/>

					<!-- Metadata -->
					<StackPanel Grid.Row="3"
								Margin="0,0,0,8">
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Grid.Column="0"
									   Text="{Binding FormattedFileSize}"
									   Foreground="#64748b"
									   FontSize="10"/>
							<TextBlock Grid.Column="1"
									   Text="{Binding RecommendedWeight, StringFormat=w: {0:F1}}"
									   Foreground="#64748b"
									   FontSize="10"
									   HorizontalAlignment="Right"/>
						</Grid>
					</StackPanel>

					<!-- Apply Button -->
					<Button Grid.Row="4"
							Content="{Binding IsLoaded, Converter={StaticResource BoolToApplyTextConverter}}"
							Command="{Binding DataContext.ApplyLoRACommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
							CommandParameter="{Binding}"
							Background="#8b5cf6"
							Foreground="White"
							BorderThickness="0"
							Padding="0,6"
							FontSize="11">
						<Button.Style>
							<Style TargetType="Button">
								<Style.Triggers>
									<DataTrigger Binding="{Binding IsLoaded}"
												 Value="True">
										<Setter Property="Background"
												Value="#4ade80"/>
										<Setter Property="Content"
												Value="âœ“ Applied"/>
									</DataTrigger>
								</Style.Triggers>
							</Style>
						</Button.Style>
					</Button>
				</Grid>
			</Border>
		</DataTemplate>

		<!-- Applied LoRA Template -->
		<DataTemplate x:Key="AppliedLoRATemplate">
			<Border Background="#1e1e1e"
					CornerRadius="6"
					Padding="12,8"
					Margin="0,0,0,8"
					BorderBrush="#8b5cf6"
					BorderThickness="1">
				<Grid>
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="80"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<!-- Order -->
					<TextBlock Grid.Column="0"
							   Text="{Binding Order}"
							   Foreground="#64748b"
							   FontSize="12"
							   VerticalAlignment="Center"
							   Width="20"
							   TextAlignment="Center"/>

					<!-- Name -->
					<TextBlock Grid.Column="1"
							   Text="{Binding Name}"
							   Foreground="#e2e8f0"
							   FontWeight="Medium"
							   FontSize="13"
							   VerticalAlignment="Center"
							   Margin="8,0"/>

					<!-- Enable/Disable Toggle - Fixed with proper rounded border -->
					<Border Grid.Column="2"
							Background="#374151"
							CornerRadius="4"
							BorderBrush="#6b7280"
							BorderThickness="1"
							Width="18"
							Height="18"
							VerticalAlignment="Center"
							Margin="0,0,8,0">
						<CheckBox IsChecked="{Binding IsEnabled}"
								  Background="Transparent"
								  BorderThickness="0"
								  Foreground="#8b5cf6"
								  HorizontalAlignment="Center"
								  VerticalAlignment="Center"/>
					</Border>

					<!-- Weight Slider -->
					<Grid Grid.Column="3"
						  VerticalAlignment="Center">
						<Grid.RowDefinitions>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="Auto"/>
						</Grid.RowDefinitions>
						<TextBlock Grid.Row="0"
								   Text="{Binding Weight, StringFormat=F2}"
								   Foreground="#94a3b8"
								   FontSize="10"
								   HorizontalAlignment="Center"/>
						<Slider Grid.Row="1"
								Value="{Binding Weight}"
								Minimum="0.0"
								Maximum="2.0"
								TickFrequency="0.1"
								Height="16"
								Foreground="#8b5cf6"/>
					</Grid>

					<!-- Move Buttons -->
					<StackPanel Grid.Column="4"
								Orientation="Horizontal"
								Margin="8,0">
						<Button Content="â†‘"
								Padding="4,2"
								FontSize="10"
								Background="#374151"
								Foreground="#94a3b8"
								BorderThickness="0"
								Margin="0,0,2,0"/>
						<Button Content="â†“"
								Padding="4,2"
								FontSize="10"
								Background="#374151"
								Foreground="#94a3b8"
								BorderThickness="0"/>
					</StackPanel>

					<!-- Remove Button -->
					<Button Grid.Column="5"
							Content="âœ•"
							Command="{Binding DataContext.RemoveLoRACommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
							CommandParameter="{Binding}"
							Background="#ef4444"
							Foreground="White"
							BorderThickness="0"
							Padding="6,4"
							FontSize="11"/>
				</Grid>
			</Border>
		</DataTemplate>
	</UserControl.Resources>

	<Grid>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="2*"/>
			<ColumnDefinition Width="*"/>
		</Grid.ColumnDefinitions>

		<!-- Left: Available LoRAs -->
		<Border Grid.Column="0"
				Background="#1a1a1a"
				CornerRadius="8"
				Padding="16"
				Margin="0,0,8,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="LoRA Collection"
							   FontWeight="Bold"
							   Foreground="White"
							   FontSize="16"/>

					<StackPanel Grid.Column="1"
								Orientation="Horizontal">
						<Border Background="#374151"
								CornerRadius="4"
								Margin="0,0,8,0">
							<Button Content="ðŸ“"
									Command="{Binding ImportLoRACommand}"
									Background="Transparent"
									Foreground="White"
									BorderThickness="0"
									Padding="8,4"
									ToolTip="Import LoRA"/>
						</Border>
						<Border Background="#374151"
								CornerRadius="4">
							<Button Content="ðŸ”„"
									Command="{Binding RefreshCommand}"
									Background="Transparent"
									Foreground="White"
									BorderThickness="0"
									Padding="8,4"
									ToolTip="Refresh"/>
						</Border>
					</StackPanel>
				</Grid>

				<!-- Filters and Search -->
				<Grid Grid.Row="1"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<Border Background="#374151"
							CornerRadius="4"
							Margin="0,0,8,0">
						<TextBox Text="{Binding SearchFilter, UpdateSourceTrigger=PropertyChanged}"
								 Background="Transparent"
								 Foreground="White"
								 BorderThickness="0"
								 Padding="12,8"
								 VerticalAlignment="Center"/>
					</Border>

					<ComboBox Grid.Column="1"
							  ItemsSource="{Binding Categories}"
							  SelectedItem="{Binding SelectedCategory}"
							  Background="#374151"
							  Foreground="White"
							  BorderBrush="#6b7280"
							  Padding="8,6"
							  Margin="0,0,8,0"
							  MinWidth="100"/>

					<ComboBox Grid.Column="2"
							  ItemsSource="{Binding SortOrders}"
							  SelectedItem="{Binding SortOrder}"
							  Background="#374151"
							  Foreground="White"
							  BorderBrush="#6b7280"
							  Padding="8,6"
							  MinWidth="100"/>
				</Grid>

				<!-- LoRA Grid -->
				<ScrollViewer Grid.Row="2"
							  VerticalScrollBarVisibility="Auto">
					<ItemsControl ItemsSource="{Binding AvailableLoRAs}"
								  ItemTemplate="{StaticResource LoRACardTemplate}">
						<ItemsControl.ItemsPanel>
							<ItemsPanelTemplate>
								<WrapPanel Orientation="Horizontal"/>
							</ItemsPanelTemplate>
						</ItemsControl.ItemsPanel>
					</ItemsControl>
				</ScrollViewer>

				<!-- Status -->
				<Grid Grid.Row="3"
					  Margin="0,16,0,0">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Grid.Column="0"
							   Text="{Binding StatusText}"
							   Foreground="#10b981"
							   FontSize="12"
							   VerticalAlignment="Center"/>

					<TextBlock Grid.Column="1"
							   Text="{Binding TotalLoRAsCount, StringFormat={}{0} LoRAs}"
							   Foreground="#64748b"
							   FontSize="12"
							   VerticalAlignment="Center"/>
				</Grid>
			</Grid>
		</Border>

		<!-- Right: Applied LoRAs Stack -->
		<Border Grid.Column="1"
				Background="#1a1a1a"
				CornerRadius="8"
				Padding="16"
				Margin="8,0,0,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="Applied Stack"
							   FontWeight="Bold"
							   Foreground="White"
							   FontSize="16"/>

					<Border Background="#ef4444"
							CornerRadius="4">
						<Button Content="Clear All"
								Command="{Binding ClearAllLoRAsCommand}"
								Background="Transparent"
								Foreground="White"
								BorderThickness="0"
								Padding="8,4"
								FontSize="11"/>
					</Border>
				</Grid>

				<!-- Applied LoRAs List -->
				<ScrollViewer Grid.Row="1"
							  VerticalScrollBarVisibility="Auto">
					<StackPanel>
						<ItemsControl ItemsSource="{Binding AppliedLoRAs}"
									  ItemTemplate="{StaticResource AppliedLoRATemplate}"/>

						<!-- Empty State -->
						<Border Background="#2d3748"
								CornerRadius="6"
								Padding="20"
								Visibility="{Binding AppliedLoRAsCount, Converter={StaticResource ZeroToVisibilityConverter}}">
							<StackPanel HorizontalAlignment="Center">
								<TextBlock Text="ðŸŽ¨"
										   FontSize="32"
										   HorizontalAlignment="Center"
										   Foreground="#64748b"
										   Margin="0,0,0,8"/>
								<TextBlock Text="No LoRAs Applied"
										   HorizontalAlignment="Center"
										   Foreground="#94a3b8"
										   FontSize="13"
										   FontWeight="Medium"/>
								<TextBlock Text="Select LoRAs from the collection to start blending"
										   HorizontalAlignment="Center"
										   Foreground="#64748b"
										   FontSize="11"
										   TextWrapping="Wrap"
										   TextAlignment="Center"
										   Margin="0,4,0,0"/>
							</StackPanel>
						</Border>
					</StackPanel>
				</ScrollViewer>

				<!-- Summary -->
				<Border Grid.Row="2"
						Background="#2d3748"
						CornerRadius="6"
						Padding="12,8"
						Margin="0,16,0,0">
					<Grid>
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
						</Grid.ColumnDefinitions>

						<StackPanel Grid.Column="0">
							<TextBlock Text="Active LoRAs"
									   Foreground="#94a3b8"
									   FontSize="10"/>
							<TextBlock Text="{Binding AppliedLoRAsCount}"
									   Foreground="#e2e8f0"
									   FontSize="16"
									   FontWeight="SemiBold"/>
						</StackPanel>

						<StackPanel Grid.Column="1">
							<TextBlock Text="Total Weight"
									   Foreground="#94a3b8"
									   FontSize="10"/>
							<TextBlock Text="{Binding TotalWeight, StringFormat=F2}"
									   Foreground="#e2e8f0"
									   FontSize="16"
									   FontWeight="SemiBold"/>
						</StackPanel>
					</Grid>
				</Border>
			</Grid>
		</Border>
	</Grid>
</UserControl>