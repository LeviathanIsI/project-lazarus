<UserControl x:Class="Lazarus.Desktop.Views.LorAsView"
			 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 mc:Ignorable="d"
			 Background="{DynamicResource PrimaryDarkBrush}">

	<UserControl.Resources>
		<!-- LoRA Card Template now provided by ViewMode system - removed local definition -->
		<!-- ViewMode templates provide LoRACardTemplate with three cognitive personalities -->
		
		<!-- Fallback LoRA Template if ViewMode system fails -->
		<DataTemplate x:Key="FallbackLoRACardTemplate">
			<Border Margin="0,0,12,12" Padding="12" 
					Background="{DynamicResource SecondaryDarkBrush}"
					CornerRadius="6" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
					MinWidth="200" MaxWidth="240">
				<StackPanel>
					<TextBlock Text="{Binding Name}" 
							   Style="{StaticResource BodyTextStyle}"
							   Foreground="{DynamicResource TextPrimaryBrush}"
							   TextTrimming="CharacterEllipsis" Margin="0,0,0,8"/>
					<TextBlock Text="FALLBACK MODE" 
							   Style="{StaticResource CaptionTextStyle}"
							   Foreground="{DynamicResource ErrorBrush}" Margin="0,0,0,8"/>
					<Button Content="Apply" Click="ApplyButton_Click"
							Style="{StaticResource PrimaryButtonStyle}" Padding="8,4"/>
				</StackPanel>
			</Border>
		</DataTemplate>

		<!-- Applied LoRA Template -->
		<DataTemplate x:Key="AppliedLoRATemplate">
			<Border Padding="12,8"
					Margin="0,0,0,8"
					BorderThickness="1">
				<Border.Style>
					<Style TargetType="Border" BasedOn="{StaticResource DarkCardStyle}">
						<Setter Property="BorderBrush" Value="{DynamicResource AccentRedBrush}"/>
						<Setter Property="Opacity" Value="1.0"/>
						<Style.Triggers>
							<DataTrigger Binding="{Binding IsEnabled}" Value="False">
								<Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
								<Setter Property="Opacity" Value="0.5"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Border.Style>
				<Grid>
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*" MinWidth="200"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="180"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<!-- Adapter Info -->
					<StackPanel Grid.Column="0" 
								Orientation="Vertical"
								VerticalAlignment="Center"
								Margin="0,4">
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>
							<TextBlock Grid.Column="0"
									   Text="{Binding Name}"
									   Style="{StaticResource BodyTextStyle}"
									   FontWeight="Medium"
									   FontSize="16"
									   TextTrimming="CharacterEllipsis"/>
							<Border Grid.Column="1"
									CornerRadius="8"
									Padding="8,4"
									Margin="8,0,0,0">
								<Border.Style>
									<Style TargetType="Border">
										<Setter Property="Background" Value="{DynamicResource SuccessBrush}"/>
										<Style.Triggers>
											<DataTrigger Binding="{Binding IsEnabled}" Value="False">
												<Setter Property="Background" Value="{DynamicResource TextMutedBrush}"/>
											</DataTrigger>
										</Style.Triggers>
									</Style>
								</Border.Style>
								<TextBlock FontSize="12"
										   FontWeight="Medium"
										   Foreground="{DynamicResource ButtonTextBrush}">
									<TextBlock.Style>
										<Style TargetType="TextBlock" BasedOn="{StaticResource CaptionTextStyle}">
											<Setter Property="Text" Value="Active"/>
											<Style.Triggers>
												<DataTrigger Binding="{Binding IsEnabled}" Value="False">
													<Setter Property="Text" Value="Inactive"/>
												</DataTrigger>
											</Style.Triggers>
										</Style>
									</TextBlock.Style>
								</TextBlock>
							</Border>
						</Grid>
						<TextBlock Text="{Binding AdapterTypeDisplay}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="13"
								   Opacity="0.8"
								   Margin="0,2,0,0"/>
					</StackPanel>

					<!-- Enable/Disable Toggle with Clear Labeling -->
					<StackPanel Grid.Column="1" 
							   Orientation="Vertical" 
							   VerticalAlignment="Center"
							   Margin="12,0">
						<TextBlock Text="Adapter Control"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="11"
								   FontWeight="SemiBold"
								   HorizontalAlignment="Center"
								   Margin="0,0,0,4"/>
						
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							
							<!-- Loading Indicator -->
							<Border Grid.Column="0" 
									Width="16" Height="16"
									Margin="0,0,6,0"
									VerticalAlignment="Center"
									Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
								<TextBlock Text="âŸ³" 
										   Style="{StaticResource BodyTextStyle}"
										   FontSize="12"
										   HorizontalAlignment="Center"
										   VerticalAlignment="Center"
										   Foreground="{DynamicResource AccentRedBrush}">
									<TextBlock.RenderTransform>
										<RotateTransform/>
									</TextBlock.RenderTransform>
									<TextBlock.Triggers>
										<EventTrigger RoutedEvent="Loaded">
											<BeginStoryboard>
												<Storyboard RepeatBehavior="Forever">
													<DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle"
																   From="0" To="360" Duration="0:0:2"/>
												</Storyboard>
											</BeginStoryboard>
										</EventTrigger>
									</TextBlock.Triggers>
								</TextBlock>
							</Border>
							
							<!-- Checkbox with Clear Label - EXORCISED OF COMMAND DEMONS -->
							<CheckBox Grid.Column="1"
									  IsChecked="{Binding IsEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
									  Style="{StaticResource DarkCheckBoxStyle}"
									  VerticalAlignment="Center"
									  IsEnabled="{Binding IsLoading, Converter={StaticResource InvertBool}}"
									  ToolTip="Toggle adapter state: Checked = Active (loaded in model), Unchecked = Inactive (unloaded from model). Changes take effect immediately.">
								<CheckBox.Content>
									<StackPanel Orientation="Vertical" Margin="4,0,0,0">
										<TextBlock FontSize="12" 
												   FontWeight="Medium"
												   Foreground="{DynamicResource TextPrimaryBrush}">
											<TextBlock.Style>
												<Style TargetType="TextBlock" BasedOn="{StaticResource BodyTextStyle}">
													<Setter Property="Text" Value="INACTIVE"/>
													<Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}"/>
													<Style.Triggers>
														<DataTrigger Binding="{Binding IsEnabled}" Value="True">
															<Setter Property="Text" Value="ACTIVE"/>
															<Setter Property="Foreground" Value="{DynamicResource SuccessBrush}"/>
														</DataTrigger>
													</Style.Triggers>
												</Style>
											</TextBlock.Style>
										</TextBlock>
										<TextBlock Text="Enable/Disable"
												   Style="{StaticResource CaptionTextStyle}"
												   FontSize="10"
												   Opacity="0.7"
												   Margin="0,1,0,0"/>
									</StackPanel>
								</CheckBox.Content>
							</CheckBox>
						</Grid>
					</StackPanel>

					<!-- Professional Weight Control with Clear Labels -->
					<Border Grid.Column="2"
							Background="{DynamicResource TertiaryDarkBrush}"
							CornerRadius="6"
							Padding="8,6"
							Margin="8,0">
						<Grid ToolTip="Adapter Weight Controls: Adjust how strongly this adapter influences the model output. Higher values = stronger effect.">
							<Grid.RowDefinitions>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
								<RowDefinition Height="Auto"/>
							</Grid.RowDefinitions>
							
							<!-- Header -->
							<Grid Grid.Row="0" Margin="0,0,0,4">
								<TextBlock Text="Weight Control"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="11"
										   FontWeight="SemiBold"
										   HorizontalAlignment="Left"/>
							</Grid>
							
							<!-- Input Instructions -->
							<TextBlock Grid.Row="1"
									   Text="Type value or drag slider"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="9"
									   Opacity="0.7"
									   HorizontalAlignment="Center"
									   Margin="0,0,0,6"/>
							
							<!-- Dual Input Row -->
							<Grid Grid.Row="2" Margin="0,0,0,4">
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="55"/>
									<ColumnDefinition Width="*"/>
								</Grid.ColumnDefinitions>
								
								<!-- Precise Text Input with Clear Label -->
								<Border Grid.Column="0" 
										Background="{DynamicResource SecondaryDarkBrush}"
										CornerRadius="3"
										BorderThickness="1"
										BorderBrush="{DynamicResource BorderBrush}">
									<TextBox Text="{Binding Weight, Mode=TwoWay, StringFormat=F2, UpdateSourceTrigger=PropertyChanged}"
											 Background="{DynamicResource TertiaryDarkBrush}"
											 Foreground="{DynamicResource TextPrimaryBrush}"
											 CaretBrush="{DynamicResource AccentRedBrush}"
											 SelectionBrush="{DynamicResource AccentRedBrush}"
											 BorderBrush="{DynamicResource BorderBrush}"
											 BorderThickness="1"
											 TextAlignment="Center"
											 FontSize="12"
											 Height="24"
											 Padding="4"
											 VerticalContentAlignment="Center"
											 Margin="2"
											 ToolTip="Direct input: Type exact weight value (0.00-2.00). Press Enter to apply immediately."
											 PreviewTextInput="WeightTextBox_PreviewTextInput"
											 KeyDown="WeightTextBox_KeyDown"/>
								</Border>
								
								<!-- Interactive Slider with Clear Visual Feedback -->
								<Border Grid.Column="1" 
										Margin="8,0,0,0"
										VerticalAlignment="Center">
									<Slider Value="{Binding Weight, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
											Minimum="0.0"
											Maximum="2.0"
											TickFrequency="0.01"
											IsSnapToTickEnabled="False"
											Height="24"
											ToolTip="Interactive slider: Drag to adjust weight in real-time. Use arrow keys for fine adjustments."/>
								</Border>
							</Grid>
							
							<!-- Clear Visual Scale with Effect Labels -->
							<Grid Grid.Row="3" Margin="0,8,0,0">
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="*"/>
									<ColumnDefinition Width="*"/>
									<ColumnDefinition Width="*"/>
								</Grid.ColumnDefinitions>
								<StackPanel Grid.Column="0" HorizontalAlignment="Left">
									<TextBlock Text="0.0" Style="{StaticResource CaptionTextStyle}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
									<TextBlock Text="Disabled" Style="{StaticResource CaptionTextStyle}" FontSize="9" Opacity="0.5" HorizontalAlignment="Center" Margin="0,1,0,0"/>
								</StackPanel>
								<StackPanel Grid.Column="1" HorizontalAlignment="Center">
									<TextBlock Text="1.0" Style="{StaticResource CaptionTextStyle}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
									<TextBlock Text="Standard" Style="{StaticResource CaptionTextStyle}" FontSize="9" Opacity="0.5" HorizontalAlignment="Center" Margin="0,1,0,0"/>
								</StackPanel>
								<StackPanel Grid.Column="2" HorizontalAlignment="Right">
									<TextBlock Text="2.0" Style="{StaticResource CaptionTextStyle}" FontSize="10" Opacity="0.6" HorizontalAlignment="Center"/>
									<TextBlock Text="Maximum" Style="{StaticResource CaptionTextStyle}" FontSize="9" Opacity="0.5" HorizontalAlignment="Center" Margin="0,1,0,0"/>
								</StackPanel>
							</Grid>
						</Grid>
					</Border>

					<!-- Remove Button Only -->
					<Button Grid.Column="3"
							Content="Remove"
							Command="{Binding DataContext.RemoveLoRACommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
							CommandParameter="{Binding}"
							Style="{StaticResource DangerButtonStyle}"
							Padding="12,6"
							FontSize="13"
							Margin="8,0,0,0"/>
				</Grid>
			</Border>
		</DataTemplate>
	</UserControl.Resources>

	<Grid>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="2*"/>
			<ColumnDefinition Width="*"/>
		</Grid.ColumnDefinitions>

		<!-- Left: Available LoRAs -->
		<Border Grid.Column="0"
				Style="{StaticResource DarkBorderStyle}"
				Margin="0,0,8,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="LoRA Collection"
							   Style="{StaticResource HeadingMediumStyle}"/>

					<StackPanel Grid.Column="1"
								Orientation="Horizontal">
						<Button Content="ðŸ“"
								Command="{Binding ImportLoRACommand}"
								Style="{StaticResource SecondaryButtonStyle}"
								Margin="0,0,8,0"
								ToolTip="Import LoRA"/>
						<Button Content="ðŸ”„"
								Command="{Binding RefreshCommand}"
								Style="{StaticResource SecondaryButtonStyle}"
								ToolTip="Refresh"/>
					</StackPanel>
				</Grid>

				<!-- Filters and Search -->
				<Grid Grid.Row="1"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBox Text="{Binding SearchFilter, UpdateSourceTrigger=PropertyChanged}"
							 Style="{StaticResource DarkTextBoxStyle}"
							 Margin="0,0,8,0"/>

					<ComboBox Grid.Column="1"
							  ItemsSource="{Binding Categories}"
							  SelectedItem="{Binding SelectedCategory}"
							  Style="{StaticResource DarkComboBoxStyle}"
							  Margin="0,0,8,0"
							  MinWidth="100">
						<ComboBox.ItemContainerStyle>
							<Style TargetType="ComboBoxItem"
								   BasedOn="{StaticResource DarkComboBoxItemStyle}"/>
						</ComboBox.ItemContainerStyle>
					</ComboBox>

					<ComboBox Grid.Column="2"
							  ItemsSource="{Binding SortOrders}"
							  SelectedItem="{Binding SortOrder}"
							  Style="{StaticResource DarkComboBoxStyle}"
							  MinWidth="100">
						<ComboBox.ItemContainerStyle>
							<Style TargetType="ComboBoxItem"
								   BasedOn="{StaticResource DarkComboBoxItemStyle}"/>
						</ComboBox.ItemContainerStyle>
					</ComboBox>
				</Grid>

				<!-- LoRA Grid - VIRTUALIZED TO PREVENT SEIZURES -->
				<ScrollViewer Grid.Row="2"
							  VerticalScrollBarVisibility="Auto"
							  ScrollViewer.CanContentScroll="True">
					<!-- ANTI-SEIZURE VIRTUALIZATION - Critical for performance -->
					<ListBox ItemsSource="{Binding AvailableLoRAs}"
							 ItemTemplate="{DynamicResource LoRACardTemplate}"
							 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
							 ScrollViewer.VerticalScrollBarVisibility="Auto"
							 ScrollViewer.CanContentScroll="True"
							 VirtualizingPanel.IsVirtualizing="True"
							 VirtualizingPanel.VirtualizationMode="Recycling"
							 VirtualizingPanel.ScrollUnit="Item"
							 Background="Transparent"
							 BorderThickness="0"
							 SelectionMode="Single">
						<ListBox.ItemsPanel>
							<ItemsPanelTemplate>
								<WrapPanel Orientation="Horizontal" 
										   VirtualizingPanel.IsVirtualizing="True"
										   IsItemsHost="True"/>
							</ItemsPanelTemplate>
						</ListBox.ItemsPanel>
						<ListBox.ItemContainerStyle>
							<Style TargetType="ListBoxItem">
								<Setter Property="Background" Value="Transparent"/>
								<Setter Property="BorderThickness" Value="0"/>
								<Setter Property="Padding" Value="0"/>
								<Setter Property="Margin" Value="0"/>
								<Setter Property="HorizontalContentAlignment" Value="Stretch"/>
								<Setter Property="VerticalContentAlignment" Value="Stretch"/>
								<Setter Property="Template">
									<Setter.Value>
										<ControlTemplate TargetType="ListBoxItem">
											<ContentPresenter/>
										</ControlTemplate>
									</Setter.Value>
								</Setter>
							</Style>
						</ListBox.ItemContainerStyle>
					</ListBox>
				</ScrollViewer>

				<!-- Status -->
				<Grid Grid.Row="3"
					  Margin="0,16,0,0">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Grid.Column="0"
							   Text="{Binding StatusText}"
							   Foreground="{DynamicResource SuccessBrush}"
							   FontSize="12"
							   VerticalAlignment="Center"/>

					<TextBlock Grid.Column="1"
							   Text="{Binding TotalLoRAsCount, StringFormat={}{0} LoRAs}"
							   Style="{StaticResource CaptionTextStyle}"
							   FontSize="12"
							   VerticalAlignment="Center"/>
				</Grid>
			</Grid>
		</Border>

		<!-- Right: Applied LoRAs Stack -->
		<Border Grid.Column="1"
				Style="{StaticResource DarkBorderStyle}"
				Margin="8,0,0,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="Applied Stack"
							   Style="{StaticResource HeadingMediumStyle}"/>

					<Button Content="Clear All"
							Command="{Binding ClearAllLoRAsCommand}"
							Style="{StaticResource DangerButtonStyle}"
							FontSize="15"/>
				</Grid>

				<!-- Applied LoRAs List -->
				<ScrollViewer Grid.Row="1"
							  VerticalScrollBarVisibility="Auto">
					<StackPanel>
						<ItemsControl ItemsSource="{Binding AppliedLoRAs}"
									  ItemTemplate="{DynamicResource AppliedLoRATemplate}"/>

						<!-- Empty State -->
						<Border Background="{DynamicResource TertiaryDarkBrush}"
								CornerRadius="6"
								Padding="20"
								Visibility="{Binding TotalAppliedLoRAsCount, Converter={StaticResource ZeroToVisibilityConverter}}">
							<StackPanel HorizontalAlignment="Center">
								<TextBlock Text="ðŸŽ¨"
										   FontSize="32"
										   HorizontalAlignment="Center"
										   Foreground="{DynamicResource TextDisabledBrush}"
										   Margin="0,0,0,8"/>
								<TextBlock Text="Ready to Blend"
										   HorizontalAlignment="Center"
										   Style="{StaticResource BodyTextStyle}"
										   FontSize="18"
										   FontWeight="Medium"/>
								<TextBlock Text="Browse LoRAs below and drag them here to start mixing"
										   HorizontalAlignment="Center"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="15"
										   TextWrapping="Wrap"
										   TextAlignment="Center"
										   Margin="0,4,0,0"/>
							</StackPanel>
						</Border>
					</StackPanel>
				</ScrollViewer>

				<!-- Summary -->
				<Border Grid.Row="2"
						Background="{DynamicResource TertiaryDarkBrush}"
						CornerRadius="6"
						Padding="12,8"
						Margin="0,16,0,0">
					<Grid>
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
						</Grid.ColumnDefinitions>

						<StackPanel Grid.Column="0">
							<TextBlock Text="Active LoRAs"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="14"/>
							<TextBlock Text="{Binding AppliedLoRAsCount}"
									   Style="{StaticResource HeadingMediumStyle}"
									   FontSize="16"/>
						</StackPanel>

						<StackPanel Grid.Column="1">
							<TextBlock Text="Total Weight"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="14"/>
							<TextBlock Text="{Binding TotalWeight, StringFormat=F2}"
									   Style="{StaticResource HeadingMediumStyle}"
									   FontSize="16"/>
						</StackPanel>
					</Grid>
				</Border>
			</Grid>
		</Border>
	</Grid>
</UserControl>