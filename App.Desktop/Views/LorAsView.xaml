<UserControl x:Class="Lazarus.Desktop.Views.LorAsView"
			 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 mc:Ignorable="d"
			 Background="{StaticResource PrimaryDarkBrush}">

	<UserControl.Resources>
		<!-- LoRA Card Template -->
		<DataTemplate x:Key="LoRACardTemplate">
			<Border MinWidth="200"
					MaxWidth="250"
					Margin="0,0,12,12">
				<Border.Style>
					<Style TargetType="Border"
						   BasedOn="{StaticResource DarkCardStyle}">
						<Style.Triggers>
							<DataTrigger Binding="{Binding IsLoaded}"
										 Value="True">
								<Setter Property="BorderBrush"
										Value="{StaticResource AccentRedBrush}"/>
								<Setter Property="BorderThickness"
										Value="2"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Border.Style>

				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
					</Grid.RowDefinitions>

					<!-- Preview Image -->
					<Border Grid.Row="0"
							Height="120"
							Background="{StaticResource TertiaryDarkBrush}"
							CornerRadius="4"
							Margin="0,0,0,8">
						<Grid>
							<Image Source="{Binding PreviewImagePath}"
								   Stretch="UniformToFill"
								   Visibility="{Binding PreviewImagePath, Converter={StaticResource StringToVisibilityConverter}}"/>
							<TextBlock Text="ðŸ“·"
									   FontSize="32"
									   Foreground="{StaticResource TextDisabledBrush}"
									   HorizontalAlignment="Center"
									   VerticalAlignment="Center"
									   Visibility="{Binding PreviewImagePath, Converter={StaticResource InverseStringToVisibilityConverter}}"/>
						</Grid>
					</Border>

					<!-- Name and Category -->
					<StackPanel Grid.Row="1"
								Margin="0,0,0,8">
						<TextBlock Text="{Binding Name}"
								   Style="{StaticResource BodyTextStyle}"
								   FontWeight="SemiBold"
								   FontSize="13"
								   TextTrimming="CharacterEllipsis"/>
						<Border Background="{StaticResource BorderBrush}"
								CornerRadius="12"
								Padding="6,2"
								HorizontalAlignment="Left"
								Margin="0,4,0,0">
							<TextBlock Text="{Binding Category}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
						</Border>
					</StackPanel>

					<!-- Description -->
					<TextBlock Grid.Row="2"
							   Text="{Binding ShortDescription}"
							   Style="{StaticResource CaptionTextStyle}"
							   FontSize="11"
							   TextWrapping="Wrap"
							   MaxHeight="40"
							   Margin="0,0,0,8"/>

					<!-- Metadata -->
					<StackPanel Grid.Row="3"
								Margin="0,0,0,8">
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Grid.Column="0"
									   Text="{Binding FormattedFileSize}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
							<TextBlock Grid.Column="1"
									   Text="{Binding RecommendedWeight, StringFormat=w: {0:F1}}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"
									   HorizontalAlignment="Right"/>
						</Grid>
					</StackPanel>

					<!-- Apply Button -->
					<Button Grid.Row="4"
							Content="{Binding IsLoaded, Converter={StaticResource BoolToApplyTextConverter}}"
							Command="{Binding DataContext.ApplyLoRACommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
							CommandParameter="{Binding}"
							Padding="8,8"
							FontSize="11">
						<Button.Style>
							<Style TargetType="Button"
								   BasedOn="{StaticResource PrimaryButtonStyle}">
								<Style.Triggers>
									<DataTrigger Binding="{Binding IsLoaded}"
												 Value="True">
										<Setter Property="Background"
												Value="{StaticResource SuccessBrush}"/>
										<Setter Property="Content"
												Value="âœ“ Applied"/>
									</DataTrigger>
								</Style.Triggers>
							</Style>
						</Button.Style>
					</Button>
				</Grid>
			</Border>
		</DataTemplate>

		<!-- Applied LoRA Template -->
		<DataTemplate x:Key="AppliedLoRATemplate">
			<Border Style="{StaticResource DarkCardStyle}"
					Padding="12,8"
					Margin="0,0,0,8"
					BorderBrush="{StaticResource AccentRedBrush}"
					BorderThickness="1">
				<Grid>
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="80"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<!-- Order -->
					<TextBlock Grid.Column="0"
							   Text="{Binding Order}"
							   Style="{StaticResource CaptionTextStyle}"
							   FontSize="12"
							   VerticalAlignment="Center"
							   Width="20"
							   TextAlignment="Center"/>

					<!-- Name -->
					<TextBlock Grid.Column="1"
							   Text="{Binding Name}"
							   Style="{StaticResource BodyTextStyle}"
							   FontWeight="Medium"
							   FontSize="13"
							   VerticalAlignment="Center"
							   Margin="8,0"/>

					<!-- Enable/Disable Toggle -->
					<CheckBox Grid.Column="2"
							  IsChecked="{Binding IsEnabled}"
							  Style="{StaticResource DarkCheckBoxStyle}"
							  VerticalAlignment="Center"
							  Margin="0,0,8,0"/>

					<!-- Weight Slider -->
					<Grid Grid.Column="3"
						  VerticalAlignment="Center">
						<Grid.RowDefinitions>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="Auto"/>
						</Grid.RowDefinitions>
						<TextBlock Grid.Row="0"
								   Text="{Binding Weight, StringFormat=F2}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="10"
								   HorizontalAlignment="Center"/>
						<Slider Grid.Row="1"
								Value="{Binding Weight}"
								Minimum="0.0"
								Maximum="2.0"
								TickFrequency="0.1"
								Height="16"
								Foreground="{StaticResource AccentRedBrush}"/>
					</Grid>

					<!-- Move Buttons -->
					<StackPanel Grid.Column="4"
								Orientation="Horizontal"
								Margin="8,0">
						<Button Content="â†‘"
								Style="{StaticResource SecondaryButtonStyle}"
								Padding="4,2"
								FontSize="10"
								Margin="0,0,2,0"/>
						<Button Content="â†“"
								Style="{StaticResource SecondaryButtonStyle}"
								Padding="4,2"
								FontSize="10"/>
					</StackPanel>

					<!-- Remove Button -->
					<Button Grid.Column="5"
							Content="âœ•"
							Command="{Binding DataContext.RemoveLoRACommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
							CommandParameter="{Binding}"
							Style="{StaticResource DangerButtonStyle}"
							Padding="6,4"
							FontSize="11"/>
				</Grid>
			</Border>
		</DataTemplate>
	</UserControl.Resources>

	<Grid>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="2*"/>
			<ColumnDefinition Width="*"/>
		</Grid.ColumnDefinitions>

		<!-- Left: Available LoRAs -->
		<Border Grid.Column="0"
				Style="{StaticResource DarkBorderStyle}"
				Margin="0,0,8,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="LoRA Collection"
							   Style="{StaticResource HeadingMediumStyle}"/>

					<StackPanel Grid.Column="1"
								Orientation="Horizontal">
						<Button Content="ðŸ“"
								Command="{Binding ImportLoRACommand}"
								Style="{StaticResource SecondaryButtonStyle}"
								Margin="0,0,8,0"
								ToolTip="Import LoRA"/>
						<Button Content="ðŸ”„"
								Command="{Binding RefreshCommand}"
								Style="{StaticResource SecondaryButtonStyle}"
								ToolTip="Refresh"/>
					</StackPanel>
				</Grid>

				<!-- Filters and Search -->
				<Grid Grid.Row="1"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBox Text="{Binding SearchFilter, UpdateSourceTrigger=PropertyChanged}"
							 Style="{StaticResource DarkTextBoxStyle}"
							 Margin="0,0,8,0"/>

					<ComboBox Grid.Column="1"
							  ItemsSource="{Binding Categories}"
							  SelectedItem="{Binding SelectedCategory}"
							  Style="{StaticResource DarkComboBoxStyle}"
							  Margin="0,0,8,0"
							  MinWidth="100">
						<ComboBox.ItemContainerStyle>
							<Style TargetType="ComboBoxItem"
								   BasedOn="{StaticResource DarkComboBoxItemStyle}"/>
						</ComboBox.ItemContainerStyle>
					</ComboBox>

					<ComboBox Grid.Column="2"
							  ItemsSource="{Binding SortOrders}"
							  SelectedItem="{Binding SortOrder}"
							  Style="{StaticResource DarkComboBoxStyle}"
							  MinWidth="100">
						<ComboBox.ItemContainerStyle>
							<Style TargetType="ComboBoxItem"
								   BasedOn="{StaticResource DarkComboBoxItemStyle}"/>
						</ComboBox.ItemContainerStyle>
					</ComboBox>
				</Grid>

				<!-- LoRA Grid -->
				<ScrollViewer Grid.Row="2"
							  VerticalScrollBarVisibility="Auto">
					<ItemsControl ItemsSource="{Binding AvailableLoRAs}"
								  ItemTemplate="{StaticResource LoRACardTemplate}">
						<ItemsControl.ItemsPanel>
							<ItemsPanelTemplate>
								<WrapPanel Orientation="Horizontal"/>
							</ItemsPanelTemplate>
						</ItemsControl.ItemsPanel>
					</ItemsControl>
				</ScrollViewer>

				<!-- Status -->
				<Grid Grid.Row="3"
					  Margin="0,16,0,0">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Grid.Column="0"
							   Text="{Binding StatusText}"
							   Foreground="{StaticResource SuccessBrush}"
							   FontSize="12"
							   VerticalAlignment="Center"/>

					<TextBlock Grid.Column="1"
							   Text="{Binding TotalLoRAsCount, StringFormat={}{0} LoRAs}"
							   Style="{StaticResource CaptionTextStyle}"
							   FontSize="12"
							   VerticalAlignment="Center"/>
				</Grid>
			</Grid>
		</Border>

		<!-- Right: Applied LoRAs Stack -->
		<Border Grid.Column="1"
				Style="{StaticResource DarkBorderStyle}"
				Margin="8,0,0,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="Applied Stack"
							   Style="{StaticResource HeadingMediumStyle}"/>

					<Button Content="Clear All"
							Command="{Binding ClearAllLoRAsCommand}"
							Style="{StaticResource DangerButtonStyle}"
							FontSize="11"/>
				</Grid>

				<!-- Applied LoRAs List -->
				<ScrollViewer Grid.Row="1"
							  VerticalScrollBarVisibility="Auto">
					<StackPanel>
						<ItemsControl ItemsSource="{Binding AppliedLoRAs}"
									  ItemTemplate="{StaticResource AppliedLoRATemplate}"/>

						<!-- Empty State -->
						<Border Background="{StaticResource TertiaryDarkBrush}"
								CornerRadius="6"
								Padding="20"
								Visibility="{Binding AppliedLoRAsCount, Converter={StaticResource ZeroToVisibilityConverter}}">
							<StackPanel HorizontalAlignment="Center">
								<TextBlock Text="ðŸŽ¨"
										   FontSize="32"
										   HorizontalAlignment="Center"
										   Foreground="{StaticResource TextDisabledBrush}"
										   Margin="0,0,0,8"/>
								<TextBlock Text="No LoRAs Applied"
										   HorizontalAlignment="Center"
										   Style="{StaticResource BodyTextStyle}"
										   FontSize="13"
										   FontWeight="Medium"/>
								<TextBlock Text="Select LoRAs from the collection to start blending"
										   HorizontalAlignment="Center"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="11"
										   TextWrapping="Wrap"
										   TextAlignment="Center"
										   Margin="0,4,0,0"/>
							</StackPanel>
						</Border>
					</StackPanel>
				</ScrollViewer>

				<!-- Summary -->
				<Border Grid.Row="2"
						Background="{StaticResource TertiaryDarkBrush}"
						CornerRadius="6"
						Padding="12,8"
						Margin="0,16,0,0">
					<Grid>
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
						</Grid.ColumnDefinitions>

						<StackPanel Grid.Column="0">
							<TextBlock Text="Active LoRAs"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
							<TextBlock Text="{Binding AppliedLoRAsCount}"
									   Style="{StaticResource HeadingMediumStyle}"
									   FontSize="16"/>
						</StackPanel>

						<StackPanel Grid.Column="1">
							<TextBlock Text="Total Weight"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
							<TextBlock Text="{Binding TotalWeight, StringFormat=F2}"
									   Style="{StaticResource HeadingMediumStyle}"
									   FontSize="16"/>
						</StackPanel>
					</Grid>
				</Border>
			</Grid>
		</Border>
	</Grid>
</UserControl>