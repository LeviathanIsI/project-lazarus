<UserControl x:Class="Lazarus.Desktop.Views.BaseModelView"
			 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:local="clr-namespace:Lazarus.Desktop.Views"
			 mc:Ignorable="d"
			 Background="{StaticResource PrimaryDarkBrush}">

	<UserControl.Resources>
		<!-- Float Parameter Template - A1111 Inspired Section -->
		<DataTemplate x:Key="FloatParameterTemplate">
			<Border Style="{StaticResource DarkCardStyle}">
				<Expander Background="Transparent"
						  BorderThickness="0"
						  IsExpanded="False">
					<Expander.Header>
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="80"/>
							</Grid.ColumnDefinitions>

							<TextBlock Grid.Column="0"
									   Text="{Binding Value.Name}"
									   Style="{StaticResource BodyTextStyle}"
									   VerticalAlignment="Center"
									   FontWeight="Medium"
									   FontSize="13"/>

							<!-- Dropdown indicator on the right -->
							<Path Grid.Column="1"
								  Fill="{StaticResource TextMutedBrush}"
								  Data="M7 10l5 5 5-5z"
								  Width="12"
								  Height="12"
								  VerticalAlignment="Center"
								  Margin="8,0,8,0"
								  RenderTransformOrigin="0.5,0.5">
								<Path.RenderTransform>
									<RotateTransform Angle="0"/>
								</Path.RenderTransform>
							</Path>

							<Border Grid.Column="2"
									Background="{StaticResource TertiaryDarkBrush}"
									CornerRadius="4"
									BorderBrush="{StaticResource BorderBrush}"
									BorderThickness="1">
								<TextBox Text="{Binding Value.DefaultValue, StringFormat=F2}"
										 Background="Transparent"
										 Foreground="{StaticResource TextPrimaryBrush}"
										 BorderThickness="0"
										 Padding="8,4"
										 TextAlignment="Center"
										 FontFamily="Consolas"
										 FontSize="12"/>
							</Border>
						</Grid>
					</Expander.Header>

					<StackPanel Margin="0,12,0,4">
						<TextBlock Text="{Binding Value.Description}"
								   Style="{StaticResource CaptionTextStyle}"
								   TextWrapping="Wrap"
								   LineHeight="16"
								   Margin="0,0,0,12"/>

						<Slider Value="{Binding Value.DefaultValue}"
								Minimum="{Binding Value.MinValue}"
								Maximum="{Binding Value.MaxValue}"
								TickFrequency="0.01"
								Foreground="{StaticResource AccentRedBrush}"
								Background="{StaticResource BorderBrush}"
								Height="20"/>
					</StackPanel>
				</Expander>
			</Border>
		</DataTemplate>

		<!-- Integer Parameter Template - A1111 Inspired Section -->
		<DataTemplate x:Key="IntParameterTemplate">
			<Border Style="{StaticResource DarkCardStyle}">
				<Expander Background="Transparent"
						  BorderThickness="0"
						  IsExpanded="False">
					<Expander.Header>
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="80"/>
							</Grid.ColumnDefinitions>

							<TextBlock Grid.Column="0"
									   Text="{Binding Value.Name}"
									   Style="{StaticResource BodyTextStyle}"
									   VerticalAlignment="Center"
									   FontWeight="Medium"
									   FontSize="13"/>

							<Path Grid.Column="1"
								  Fill="{StaticResource TextMutedBrush}"
								  Data="M7 10l5 5 5-5z"
								  Width="12"
								  Height="12"
								  VerticalAlignment="Center"
								  Margin="8,0,8,0"/>

							<Border Grid.Column="2"
									Background="{StaticResource TertiaryDarkBrush}"
									CornerRadius="4"
									BorderBrush="{StaticResource BorderBrush}"
									BorderThickness="1">
								<TextBox Text="{Binding Value.DefaultValue}"
										 Background="Transparent"
										 Foreground="{StaticResource TextPrimaryBrush}"
										 BorderThickness="0"
										 Padding="8,4"
										 TextAlignment="Center"
										 FontFamily="Consolas"
										 FontSize="12"/>
							</Border>
						</Grid>
					</Expander.Header>

					<StackPanel Margin="0,12,0,4">
						<TextBlock Text="{Binding Value.Description}"
								   Style="{StaticResource CaptionTextStyle}"
								   TextWrapping="Wrap"
								   LineHeight="16"
								   Margin="0,0,0,12"/>

						<Slider Value="{Binding Value.DefaultValue}"
								Minimum="{Binding Value.MinValue}"
								Maximum="{Binding Value.MaxValue}"
								TickFrequency="1"
								IsSnapToTickEnabled="True"
								Foreground="{StaticResource AccentRedBrush}"
								Background="{StaticResource BorderBrush}"
								Height="20"/>
					</StackPanel>
				</Expander>
			</Border>
		</DataTemplate>

		<!-- Boolean Parameter Template - A1111 Inspired Section -->
		<DataTemplate x:Key="BoolParameterTemplate">
			<Border Style="{StaticResource DarkCardStyle}">
				<Expander Background="Transparent"
						  BorderThickness="0"
						  IsExpanded="False">
					<Expander.Header>
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>

							<TextBlock Grid.Column="0"
									   Text="{Binding Value.Name}"
									   Style="{StaticResource BodyTextStyle}"
									   VerticalAlignment="Center"
									   FontWeight="Medium"
									   FontSize="13"/>

							<Path Grid.Column="1"
								  Fill="{StaticResource TextMutedBrush}"
								  Data="M7 10l5 5 5-5z"
								  Width="12"
								  Height="12"
								  VerticalAlignment="Center"
								  Margin="8,0,8,0"/>

							<CheckBox Grid.Column="2"
									  IsChecked="{Binding Value.DefaultValue}"
									  Style="{StaticResource DarkCheckBoxStyle}"/>
						</Grid>
					</Expander.Header>

					<TextBlock Text="{Binding Value.Description}"
							   Style="{StaticResource CaptionTextStyle}"
							   TextWrapping="Wrap"
							   LineHeight="16"
							   Margin="0,12,0,4"/>
				</Expander>
			</Border>
		</DataTemplate>

		<!-- Dropdown Parameter Template - A1111 Inspired Section -->
		<DataTemplate x:Key="DropdownParameterTemplate">
			<Border Style="{StaticResource DarkCardStyle}">
				<Expander Background="Transparent"
						  BorderThickness="0"
						  IsExpanded="False">
					<Expander.Header>
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="120"/>
							</Grid.ColumnDefinitions>

							<TextBlock Grid.Column="0"
									   Text="{Binding Value.Name}"
									   Style="{StaticResource BodyTextStyle}"
									   VerticalAlignment="Center"
									   FontWeight="Medium"
									   FontSize="13"/>

							<Path Grid.Column="1"
								  Fill="{StaticResource TextMutedBrush}"
								  Data="M7 10l5 5 5-5z"
								  Width="12"
								  Height="12"
								  VerticalAlignment="Center"
								  Margin="8,0,8,0"/>

							<ComboBox Grid.Column="2"
									  ItemsSource="{Binding Value.AllowedValues}"
									  SelectedItem="{Binding Value.DefaultValue}"
									  Style="{StaticResource DarkComboBoxStyle}">
								<ComboBox.ItemContainerStyle>
									<Style TargetType="ComboBoxItem"
										   BasedOn="{StaticResource DarkComboBoxItemStyle}"/>
								</ComboBox.ItemContainerStyle>
							</ComboBox>
						</Grid>
					</Expander.Header>

					<TextBlock Text="{Binding Value.Description}"
							   Style="{StaticResource CaptionTextStyle}"
							   TextWrapping="Wrap"
							   LineHeight="16"
							   Margin="0,12,0,4"/>
				</Expander>
			</Border>
		</DataTemplate>

		<!-- Parameter Template Selector -->
		<local:ParameterTemplateSelector x:Key="ParameterTemplateSelector"
										 FloatTemplate="{StaticResource FloatParameterTemplate}"
										 IntTemplate="{StaticResource IntParameterTemplate}"
										 BoolTemplate="{StaticResource BoolParameterTemplate}"
										 DropdownTemplate="{StaticResource DropdownParameterTemplate}"/>
	</UserControl.Resources>

	<ScrollViewer VerticalScrollBarVisibility="Auto">
		<Grid>
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="*"/>
			</Grid.ColumnDefinitions>

			<!-- Left Column: Model Selection & Dynamic Sampling -->
			<StackPanel Grid.Column="0"
						Margin="0,0,8,0">
				<!-- Model Selection -->
				<Border Style="{StaticResource DarkBorderStyle}"
						Margin="0,0,0,16">
					<StackPanel>
						<TextBlock Text="Model Selection"
								   Style="{StaticResource HeadingMediumStyle}"
								   Margin="0,0,0,12"/>

						<Grid Margin="0,0,0,12">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>

							<ComboBox ItemsSource="{Binding BaseModels}"
									  SelectedItem="{Binding SelectedModel}"
									  DisplayMemberPath="Name"
									  Style="{StaticResource DarkComboBoxStyle}"/>

							<Button Grid.Column="1"
									Content="Load"
									Style="{StaticResource PrimaryButtonStyle}"
									Margin="8,0,0,0"
									Command="{Binding LoadModelCommand}"
									CommandParameter="{Binding SelectedModel}"/>
						</Grid>

						<TextBlock Text="{Binding StatusText}"
								   Foreground="{StaticResource SuccessBrush}"
								   FontSize="12"
								   Margin="0,4,0,0"/>
					</StackPanel>
				</Border>

				<!-- Dynamic Sampling Parameters -->
				<Border Style="{StaticResource DarkBorderStyle}">
					<StackPanel>
						<Grid Margin="0,0,0,16">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>
							<TextBlock Text="Sampling Parameters"
									   Style="{StaticResource HeadingMediumStyle}"/>

							<!-- Loading indicator -->
							<StackPanel Grid.Column="1"
										Orientation="Horizontal"
										Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
								<TextBlock Text="Scanning..."
										   Style="{StaticResource CaptionTextStyle}"
										   Margin="0,0,8,0"/>
								<Border Background="{StaticResource AccentRedBrush}"
										Width="16"
										Height="16"
										CornerRadius="8">
									<Border.RenderTransform>
										<RotateTransform x:Name="LoadingRotation"/>
									</Border.RenderTransform>
									<Border.Triggers>
										<EventTrigger RoutedEvent="Border.Loaded">
											<BeginStoryboard>
												<Storyboard RepeatBehavior="Forever">
													<DoubleAnimation Storyboard.TargetName="LoadingRotation"
																	 Storyboard.TargetProperty="Angle"
																	 From="0"
																	 To="360"
																	 Duration="0:0:1"/>
												</Storyboard>
											</BeginStoryboard>
										</EventTrigger>
									</Border.Triggers>
								</Border>
							</StackPanel>
						</Grid>

						<!-- Dynamic parameter controls -->
						<ItemsControl ItemsSource="{Binding SupportedParameterSchema}">
							<ItemsControl.ItemTemplate>
								<DataTemplate>
									<Border Visibility="{Binding Value.IsSupported, Converter={StaticResource BooleanToVisibilityConverter}}">
										<ContentPresenter Content="{Binding}"
														  ContentTemplateSelector="{StaticResource ParameterTemplateSelector}"/>
									</Border>
								</DataTemplate>
							</ItemsControl.ItemTemplate>
						</ItemsControl>

						<!-- Fallback message -->
						<TextBlock Text="Load a model to see available parameters..."
								   Style="{StaticResource CaptionTextStyle}"
								   FontStyle="Italic"
								   Visibility="{Binding SupportedParameterSchema.Count, Converter={StaticResource ZeroToVisibilityConverter}}"
								   Margin="0,8,0,0"/>
					</StackPanel>
				</Border>
			</StackPanel>

			<!-- Right Column: System Prompt, Test Prompt & Model Info -->
			<StackPanel Grid.Column="1"
						Margin="8,0,0,0">
				<!-- System Prompt -->
				<Border Style="{StaticResource DarkBorderStyle}"
						Margin="0,0,0,16">
					<StackPanel>
						<TextBlock Text="System Prompt"
								   Style="{StaticResource HeadingMediumStyle}"
								   Margin="0,0,0,12"/>
						<TextBox Style="{StaticResource DarkTextBoxMultilineStyle}"
								 MinHeight="150"
								 Text="You are a helpful, harmless, and honest AI assistant."/>
					</StackPanel>
				</Border>

				<!-- Test Prompt Laboratory -->
				<Border Style="{StaticResource DarkBorderStyle}"
						Margin="0,0,0,16">
					<StackPanel>
						<TextBlock Text="Test Prompt"
								   Style="{StaticResource HeadingMediumStyle}"
								   Margin="0,0,0,12"/>

						<TextBox Style="{StaticResource DarkTextBoxMultilineStyle}"
								 MinHeight="100"
								 Text="{Binding TestPromptText, UpdateSourceTrigger=PropertyChanged}"
								 Margin="0,0,0,12"
								 TabIndex="1"/>

						<Grid Margin="0,0,0,12">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="*"/>
								<ColumnDefinition Width="Auto"/>
							</Grid.ColumnDefinitions>

							<Button Content="Execute Test"
									Style="{StaticResource PrimaryButtonStyle}"
									Command="{Binding TestParametersCommand}"
									IsEnabled="{Binding CanExecuteTest}"/>

							<StackPanel Grid.Column="1"
										Orientation="Horizontal"
										Margin="12,0,0,0">
								<TextBlock Text="{Binding TestStatus}"
										   Foreground="{StaticResource SuccessBrush}"
										   FontSize="12"
										   VerticalAlignment="Center"/>

								<!-- Test execution spinner -->
								<Border Background="{StaticResource AccentRedBrush}"
										Width="12"
										Height="12"
										CornerRadius="6"
										Margin="8,0,0,0"
										Visibility="{Binding IsTestRunning, Converter={StaticResource BooleanToVisibilityConverter}}">
									<Border.RenderTransform>
										<RotateTransform x:Name="TestSpinner"/>
									</Border.RenderTransform>
									<Border.Triggers>
										<EventTrigger RoutedEvent="Border.Loaded">
											<BeginStoryboard>
												<Storyboard RepeatBehavior="Forever">
													<DoubleAnimation Storyboard.TargetName="TestSpinner"
																	 Storyboard.TargetProperty="Angle"
																	 From="0"
																	 To="360"
																	 Duration="0:0:0.8"/>
												</Storyboard>
											</BeginStoryboard>
										</EventTrigger>
									</Border.Triggers>
								</Border>
							</StackPanel>
						</Grid>

						<!-- Response area with proper visibility logic -->
						<Border Background="{StaticResource PrimaryDarkBrush}"
								BorderBrush="{StaticResource BorderBrush}"
								BorderThickness="1"
								CornerRadius="4"
								Padding="12"
								MinHeight="120">
							<ScrollViewer VerticalScrollBarVisibility="Auto">
								<StackPanel>
									<!-- Actual response text -->
									<TextBlock Text="{Binding TestResponse}"
											   Foreground="{StaticResource TextPrimaryBrush}"
											   TextWrapping="Wrap">
										<TextBlock.Style>
											<Style TargetType="TextBlock">
												<Setter Property="Visibility"
														Value="Collapsed"/>
												<Style.Triggers>
													<DataTrigger Binding="{Binding TestResponse, Converter={StaticResource StringToBool}}"
																 Value="True">
														<Setter Property="Visibility"
																Value="Visible"/>
													</DataTrigger>
												</Style.Triggers>
											</Style>
										</TextBlock.Style>
									</TextBlock>

									<!-- Placeholder text -->
									<TextBlock Text="Craft your dark prompt above and hit Execute Test to watch the model's digital soul respond..."
											   FontStyle="Italic"
											   TextWrapping="Wrap">
										<TextBlock.Style>
											<Style TargetType="TextBlock"
												   BasedOn="{StaticResource CaptionTextStyle}">
												<Setter Property="Visibility"
														Value="Visible"/>
												<Style.Triggers>
													<DataTrigger Binding="{Binding TestResponse, Converter={StaticResource StringToBool}}"
																 Value="True">
														<Setter Property="Visibility"
																Value="Collapsed"/>
													</DataTrigger>
												</Style.Triggers>
											</Style>
										</TextBlock.Style>
									</TextBlock>
								</StackPanel>
							</ScrollViewer>
						</Border>
					</StackPanel>
				</Border>

				<!-- Model Information -->
				<Border Style="{StaticResource DarkBorderStyle}"
						Margin="0,0,0,16">
					<StackPanel>
						<TextBlock Text="Model Information"
								   Style="{StaticResource HeadingMediumStyle}"
								   Margin="0,0,0,12"/>

						<Grid Margin="0,0,0,6">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Text="Size:"
									   Style="{StaticResource CaptionTextStyle}"
									   Width="80"/>
							<TextBlock Grid.Column="1"
									   Text="{Binding SelectedModel.Size}"
									   Style="{StaticResource BodyTextStyle}"/>
						</Grid>

						<Grid Margin="0,0,0,6">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Text="Context:"
									   Style="{StaticResource CaptionTextStyle}"
									   Width="80"/>
							<TextBlock Grid.Column="1"
									   Text="{Binding SelectedModel.ContextLength}"
									   Style="{StaticResource BodyTextStyle}"/>
						</Grid>

						<Grid Margin="0,0,0,6">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Text="Arch:"
									   Style="{StaticResource CaptionTextStyle}"
									   Width="80"/>
							<TextBlock Grid.Column="1"
									   Text="{Binding SelectedModel.Architecture}"
									   Style="{StaticResource BodyTextStyle}"/>
						</Grid>

						<Grid Margin="0,0,0,6">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Text="Quant:"
									   Style="{StaticResource CaptionTextStyle}"
									   Width="80"/>
							<TextBlock Grid.Column="1"
									   Text="{Binding SelectedModel.Quantization}"
									   Style="{StaticResource BodyTextStyle}"/>
						</Grid>

						<!-- Parameter Summary -->
						<Grid Margin="0,6,0,0">
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							<TextBlock Text="Params:"
									   Style="{StaticResource CaptionTextStyle}"
									   Width="80"/>
							<TextBlock Grid.Column="1"
									   Text="{Binding SupportedParameterSchema.Count, StringFormat={}{0} available}"
									   Style="{StaticResource BodyTextStyle}"/>
						</Grid>
					</StackPanel>
				</Border>
			</StackPanel>
		</Grid>
	</ScrollViewer>
</UserControl>