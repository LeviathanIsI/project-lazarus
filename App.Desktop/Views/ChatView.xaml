<UserControl x:Class="Lazarus.Desktop.Views.ChatView"
			 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 mc:Ignorable="d">

	<Grid Margin="12">
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="*"/>
			<ColumnDefinition Width="300" MinWidth="250"/>
		</Grid.ColumnDefinitions>

		<!-- Main Chat Area -->
		<Grid Grid.Column="0">
			<Grid.RowDefinitions>
				<RowDefinition Height="*"/>
				<RowDefinition Height="Auto"/>
			</Grid.RowDefinitions>

			<!-- No Model Loaded State -->
			<Grid Grid.Row="0" 
					Visibility="{Binding HasBaseModel, Converter={StaticResource InverseBooleanToVisibilityConverter}}"
					Background="{DynamicResource SecondaryDarkBrush}">
				<TextBlock Text="No Base Model Loaded - Please configure a model first" 
					       HorizontalAlignment="Center" 
					       VerticalAlignment="Center"
					       FontSize="16" 
					       Foreground="{DynamicResource TextSecondaryBrush}"/>
			</Grid>

			<!-- Chat Messages Area -->
			<Grid Grid.Row="0"
					Visibility="{Binding HasBaseModel, Converter={StaticResource BooleanToVisibilityConverter}}">
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
				</Grid.RowDefinitions>
				<!-- Mode-specific toolbar (model, tabs, search, parameters, etc.) -->
				<ContentControl Grid.Row="0" Content="{Binding}" ContentTemplate="{DynamicResource ChatToolbarTemplate}"/>
				<ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="16"
						  Background="{DynamicResource SecondaryDarkBrush}"
						  x:Name="ChatScrollViewer">
					<ItemsControl ItemsSource="{Binding Messages}"
								  ItemTemplate="{DynamicResource ChatMessageTemplate}"/>
				</ScrollViewer>
			</Grid>

			<!-- Input -->
			<Border Grid.Row="1"
					Background="{DynamicResource TertiaryDarkBrush}"
					CornerRadius="8"
					Padding="8"
					Margin="0,8,0,0"
					Visibility="{Binding HasBaseModel, Converter={StaticResource BooleanToVisibilityConverter}}">
				<!-- Mode-specific input area -->
				<ContentControl Content="{Binding}" ContentTemplate="{DynamicResource ChatInputTemplate}"/>
			</Border>
		</Grid>

		<!-- Dynamic Parameters Panel -->
		<Border Grid.Column="1"
				Background="{DynamicResource SecondaryDarkBrush}"
				CornerRadius="8"
				Margin="8,0,0,0"
				Padding="12"
				Visibility="{Binding HasBaseModel, Converter={StaticResource BooleanToVisibilityConverter}}">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<StackPanel Grid.Row="0" Margin="0,0,0,12">
					<TextBlock Text="Model Parameters"
							   Style="{StaticResource BodyTextStyle}"
							   FontSize="14"
							   FontWeight="SemiBold"
							   Margin="0,0,0,6"/>
					<TextBlock Text="{Binding ParameterViewModel.ModelSummary}"
							   Style="{StaticResource CaptionTextStyle}"
							   TextWrapping="Wrap"
							   Opacity="0.8"/>
					   
					<!-- LoRA Status Indicator with Clear Messaging -->
					<Border CornerRadius="6"
							Padding="10,6"
							Margin="0,8,0,0">
						<Border.Style>
							<Style TargetType="Border">
								<Setter Property="Background" Value="{DynamicResource AccentRedBrush}"/>
								<Setter Property="Visibility" Value="{Binding ParameterViewModel.HasActiveLoRAs, Converter={StaticResource BooleanToVisibilityConverter}}"/>
								<Style.Triggers>
									<DataTrigger Binding="{Binding ParameterViewModel.HasActiveLoRAs}" Value="False">
										<Setter Property="Background" Value="{DynamicResource BorderBrush}"/>
										<Setter Property="Visibility" Value="{Binding ParameterViewModel.AppliedLoRAs.Count, Converter={StaticResource ZeroToVisibilityConverter}, ConverterParameter=Inverse}"/>
									</DataTrigger>
								</Style.Triggers>
							</Style>
						</Border.Style>
						
						<Grid>
							<Grid.ColumnDefinitions>
								<ColumnDefinition Width="Auto"/>
								<ColumnDefinition Width="*"/>
							</Grid.ColumnDefinitions>
							
							<!-- Status Icon -->
							<TextBlock Grid.Column="0"
									   FontSize="16"
									   VerticalAlignment="Center"
									   Margin="0,0,8,0">
								<TextBlock.Style>
									<Style TargetType="TextBlock" BasedOn="{StaticResource BodyTextStyle}">
										<Setter Property="Text" Value="âš¡"/>
										<Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
										<Style.Triggers>
											<DataTrigger Binding="{Binding ParameterViewModel.HasActiveLoRAs}" Value="False">
												<Setter Property="Text" Value="ðŸ’¤"/>
												<Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}"/>
											</DataTrigger>
										</Style.Triggers>
									</Style>
								</TextBlock.Style>
							</TextBlock>
						   
							<StackPanel Grid.Column="1">
								<!-- Main Status Header -->
								<TextBlock FontSize="13"
										   FontWeight="SemiBold"
										   Foreground="{DynamicResource TextPrimaryBrush}">
									<TextBlock.Style>
										<Style TargetType="TextBlock" BasedOn="{StaticResource BodyTextStyle}">
											<Setter Property="Text" Value="Adapters Active - Model Modified"/>
											<Style.Triggers>
												<DataTrigger Binding="{Binding ParameterViewModel.HasActiveLoRAs}" Value="False">
													<Setter Property="Text" Value="Adapters Inactive - Base Model"/>
												</DataTrigger>
											</Style.Triggers>
										</Style>
									</TextBlock.Style>
								</TextBlock>
								
								<!-- Detailed Status -->
								<TextBlock Text="{Binding ParameterViewModel.LoRAStatusSummary}"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="12"
										   Foreground="{DynamicResource TextPrimaryBrush}"
										   TextWrapping="Wrap"
										   Opacity="0.9"/>
							</StackPanel>
						</Grid>
					</Border>
				</StackPanel>
				
				<!-- Parameters List -->
				<ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
					<ItemsControl ItemsSource="{Binding ParameterViewModel.VisibleParameters}"
								  ItemTemplate="{DynamicResource ParameterControlTemplate}"/>
				</ScrollViewer>
			</Grid>
		</Border>
	</Grid>
</UserControl>