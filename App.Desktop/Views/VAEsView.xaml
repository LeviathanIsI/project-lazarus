<UserControl x:Class="Lazarus.Desktop.Views.VAEsView"
			 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:local="clr-namespace:Lazarus.Desktop.Views"
			 xmlns:conv="clr-namespace:Lazarus.Desktop.Converters"
			 mc:Ignorable="d"
			 Background="{StaticResource PrimaryDarkBrush}">

	<UserControl.Resources>
		<!-- VAE Card Template -->
		<DataTemplate x:Key="VAECardTemplate">
			<Border MinWidth="240"
					MaxWidth="280"
					Margin="0,0,12,12">
				<Border.Style>
					<Style TargetType="Border"
						   BasedOn="{StaticResource DarkCardStyle}">
						<Style.Triggers>
							<DataTrigger Binding="{Binding IsLoaded}"
										 Value="True">
								<Setter Property="BorderBrush"
										Value="{StaticResource AccentPurpleBrush}"/>
								<Setter Property="BorderThickness"
										Value="2"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Border.Style>

				<Grid>
					<Grid.RowDefinitions>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="*"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
						<RowDefinition Height="Auto"/>
					</Grid.RowDefinitions>

					<!-- Header with Category Badge -->
					<Grid Grid.Row="0"
						  Margin="0,0,0,8">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<TextBlock Grid.Column="0"
								   Text="âš¡"
								   FontSize="24"
								   Foreground="{StaticResource AccentPurpleBrush}"
								   VerticalAlignment="Center"/>

						<Border Grid.Column="1"
								Background="{StaticResource AccentPurpleBrush}"
								CornerRadius="8"
								Padding="6,2">
							<TextBlock Text="{Binding Category}"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="9"
									   FontWeight="Bold"/>
						</Border>
					</Grid>

					<!-- Name and Architecture -->
					<StackPanel Grid.Row="1"
								Margin="0,0,0,8">
						<TextBlock Text="{Binding Name}"
								   Style="{StaticResource BodyTextStyle}"
								   FontWeight="SemiBold"
								   FontSize="13"
								   TextTrimming="CharacterEllipsis"/>
						<TextBlock Text="{Binding Architecture}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="10"
								   Margin="0,2,0,0"/>
					</StackPanel>

					<!-- Description -->
					<TextBlock Grid.Row="2"
							   Text="{Binding Description}"
							   Style="{StaticResource CaptionTextStyle}"
							   FontSize="11"
							   TextWrapping="Wrap"
							   MaxHeight="60"
							   Margin="0,0,0,8"/>

					<!-- Specs Grid -->
					<Grid Grid.Row="3"
						  Margin="0,0,0,8">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
						</Grid.ColumnDefinitions>
						<Grid.RowDefinitions>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="Auto"/>
							<RowDefinition Height="Auto"/>
						</Grid.RowDefinitions>

						<TextBlock Grid.Row="0"
								   Grid.Column="0"
								   Text="{Binding FileSize}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="9"/>
						<TextBlock Grid.Row="0"
								   Grid.Column="1"
								   Text="{Binding Resolution}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="9"
								   HorizontalAlignment="Right"/>

						<TextBlock Grid.Row="1"
								   Grid.Column="0"
								   Text="{Binding Quality}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="9"/>
						<TextBlock Grid.Row="1"
								   Grid.Column="1"
								   Text="{Binding FormattedTrainingSteps}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="9"
								   HorizontalAlignment="Right"/>

						<TextBlock Grid.Row="2"
								   Grid.ColumnSpan="2"
								   Text="{Binding Compatibility}"
								   Style="{StaticResource CaptionTextStyle}"
								   FontSize="9"
								   HorizontalAlignment="Center"
								   Margin="0,2,0,0"/>
					</Grid>

					<!-- Action Buttons -->
					<Grid Grid.Row="4"
						  Margin="0,0,0,4">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="Auto"/>
						</Grid.ColumnDefinitions>

						<Button Grid.Column="0"
								Command="{Binding DataContext.LoadVAECommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
								CommandParameter="{Binding}"
								Padding="0,6"
								FontSize="11"
								Margin="0,0,4,0">
							<Button.Style>
								<Style TargetType="Button"
									   BasedOn="{StaticResource PrimaryButtonStyle}">
									<Setter Property="Content"
											Value="Load"/>
									<Style.Triggers>
										<DataTrigger Binding="{Binding IsLoaded}"
													 Value="True">
											<Setter Property="Background"
													Value="{StaticResource SuccessBrush}"/>
											<Setter Property="Content"
													Value="âœ“ Active"/>
										</DataTrigger>
									</Style.Triggers>
								</Style>
							</Button.Style>
						</Button>

						<Button Grid.Column="1"
								Content="Test"
								Command="{Binding DataContext.TestVAECommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
								CommandParameter="{Binding}"
								Style="{StaticResource SecondaryButtonStyle}"
								Padding="8,6"
								FontSize="10"/>
					</Grid>

					<!-- Hash -->
					<TextBlock Grid.Row="5"
							   Text="{Binding Hash, StringFormat={}Hash: {0}}"
							   Style="{StaticResource CaptionTextStyle}"
							   FontSize="8"
							   HorizontalAlignment="Center"
							   Opacity="0.7"/>
				</Grid>
			</Border>
		</DataTemplate>
	</UserControl.Resources>

	<Grid>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="2*"/>
			<ColumnDefinition Width="1*"/>
		</Grid.ColumnDefinitions>

		<!-- Left: Available VAEs -->
		<Border Grid.Column="0"
				Style="{StaticResource DarkBorderStyle}"
				Margin="0,0,8,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="VAE Models"
							   Style="{StaticResource HeadingMediumStyle}"/>

					<Button Content="ðŸ”„"
							Command="{Binding RefreshCommand}"
							Style="{StaticResource SecondaryButtonStyle}"
							Padding="8,4"
							ToolTip="Refresh Models"/>
				</Grid>

				<!-- Filters -->
				<Grid Grid.Row="1"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBox Text="{Binding SearchFilter, UpdateSourceTrigger=PropertyChanged}"
							 Style="{StaticResource DarkTextBoxStyle}"
							 Margin="0,0,8,0"/>

					<ComboBox Grid.Column="1"
							  ItemsSource="{Binding Categories}"
							  SelectedItem="{Binding SelectedCategory}"
							  Style="{StaticResource DarkComboBoxStyle}"
							  MinWidth="120"/>
				</Grid>

				<!-- VAE Grid -->
				<ScrollViewer Grid.Row="2"
							  VerticalScrollBarVisibility="Auto">
					<ItemsControl ItemsSource="{Binding AvailableVAEs}"
								  ItemTemplate="{StaticResource VAECardTemplate}">
						<ItemsControl.ItemsPanel>
							<ItemsPanelTemplate>
								<WrapPanel Orientation="Horizontal"/>
							</ItemsPanelTemplate>
						</ItemsControl.ItemsPanel>
					</ItemsControl>
				</ScrollViewer>

				<!-- Status -->
				<Grid Grid.Row="3"
					  Margin="0,16,0,0">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Grid.Column="0"
							   Text="{Binding StatusText}"
							   Foreground="{StaticResource SuccessBrush}"
							   FontSize="12"
							   VerticalAlignment="Center"/>

					<!-- Loading indicator - FIXED VERSION -->
					<StackPanel Grid.Column="1"
								Orientation="Horizontal"
								Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
						<TextBlock Text="Encoding..."
								   Style="{StaticResource CaptionTextStyle}"
								   Margin="0,0,8,0"/>
						<Border Background="{StaticResource AccentPurpleBrush}"
								Width="12"
								Height="12"
								CornerRadius="6">
							<Border.RenderTransform>
								<RotateTransform/>
							</Border.RenderTransform>
							<Border.Triggers>
								<EventTrigger RoutedEvent="Border.Loaded">
									<BeginStoryboard>
										<Storyboard RepeatBehavior="Forever">
											<DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
															 From="0"
															 To="360"
															 Duration="0:0:1"/>
										</Storyboard>
									</BeginStoryboard>
								</EventTrigger>
							</Border.Triggers>
						</Border>
					</StackPanel>
				</Grid>
			</Grid>
		</Border>

		<!-- Right: Active VAE Status -->
		<Border Grid.Column="1"
				Style="{StaticResource DarkBorderStyle}"
				Margin="8,0,0,0">
			<Grid>
				<Grid.RowDefinitions>
					<RowDefinition Height="Auto"/>
					<RowDefinition Height="*"/>
					<RowDefinition Height="Auto"/>
				</Grid.RowDefinitions>

				<!-- Header -->
				<Grid Grid.Row="0"
					  Margin="0,0,0,16">
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="*"/>
						<ColumnDefinition Width="Auto"/>
					</Grid.ColumnDefinitions>

					<TextBlock Text="Active VAE"
							   Style="{StaticResource HeadingMediumStyle}"/>

					<Button Content="Unload"
							Command="{Binding UnloadVAECommand}"
							Style="{StaticResource DangerButtonStyle}"
							Padding="8,4"
							FontSize="11"
							Visibility="{Binding HasActiveVAE, Converter={StaticResource BooleanToVisibilityConverter}}"/>
				</Grid>

				<!-- Active VAE Details -->
				<ScrollViewer Grid.Row="1"
							  VerticalScrollBarVisibility="Auto">
					<StackPanel>
						<!-- Active VAE Card -->
						<Border Background="{StaticResource TertiaryDarkBrush}"
								CornerRadius="6"
								Padding="16"
								Margin="0,0,0,16"
								Visibility="{Binding HasActiveVAE, Converter={StaticResource BooleanToVisibilityConverter}}">
							<StackPanel>
								<Grid Margin="0,0,0,12">
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="*"/>
										<ColumnDefinition Width="Auto"/>
									</Grid.ColumnDefinitions>

									<TextBlock Grid.Column="0"
											   Text="{Binding ActiveVAE.Name}"
											   Style="{StaticResource HeadingSmallStyle}"
											   FontSize="14"/>

									<Border Grid.Column="1"
											Background="{StaticResource AccentPurpleBrush}"
											CornerRadius="8"
											Padding="6,2">
										<TextBlock Text="{Binding ActiveVAE.Category}"
												   Style="{StaticResource CaptionTextStyle}"
												   FontSize="9"
												   FontWeight="Bold"/>
									</Border>
								</Grid>

								<TextBlock Text="{Binding ActiveVAE.Description}"
										   Style="{StaticResource CaptionTextStyle}"
										   TextWrapping="Wrap"
										   Margin="0,0,0,12"/>

								<!-- Specs -->
								<Grid>
									<Grid.ColumnDefinitions>
										<ColumnDefinition Width="*"/>
										<ColumnDefinition Width="*"/>
									</Grid.ColumnDefinitions>
									<Grid.RowDefinitions>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
										<RowDefinition Height="Auto"/>
									</Grid.RowDefinitions>

									<TextBlock Grid.Row="0"
											   Grid.Column="0"
											   Text="Architecture:"
											   Style="{StaticResource CaptionTextStyle}"
											   FontSize="10"/>
									<TextBlock Grid.Row="0"
											   Grid.Column="1"
											   Text="{Binding ActiveVAE.Architecture}"
											   Style="{StaticResource BodyTextStyle}"
											   FontSize="10"
											   HorizontalAlignment="Right"/>

									<TextBlock Grid.Row="1"
											   Grid.Column="0"
											   Text="Resolution:"
											   Style="{StaticResource CaptionTextStyle}"
											   FontSize="10"/>
									<TextBlock Grid.Row="1"
											   Grid.Column="1"
											   Text="{Binding ActiveVAE.Resolution}"
											   Style="{StaticResource BodyTextStyle}"
											   FontSize="10"
											   HorizontalAlignment="Right"/>

									<TextBlock Grid.Row="2"
											   Grid.Column="0"
											   Text="Quality:"
											   Style="{StaticResource CaptionTextStyle}"
											   FontSize="10"/>
									<TextBlock Grid.Row="2"
											   Grid.Column="1"
											   Text="{Binding ActiveVAE.Quality}"
											   Style="{StaticResource BodyTextStyle}"
											   FontSize="10"
											   HorizontalAlignment="Right"/>

									<TextBlock Grid.Row="3"
											   Grid.Column="0"
											   Text="Training Steps:"
											   Style="{StaticResource CaptionTextStyle}"
											   FontSize="10"/>
									<TextBlock Grid.Row="3"
											   Grid.Column="1"
											   Text="{Binding ActiveVAE.FormattedTrainingSteps}"
											   Style="{StaticResource BodyTextStyle}"
											   FontSize="10"
											   HorizontalAlignment="Right"/>

									<TextBlock Grid.Row="4"
											   Grid.ColumnSpan="2"
											   Text="{Binding ActiveVAE.Compatibility}"
											   Style="{StaticResource CaptionTextStyle}"
											   FontSize="10"
											   HorizontalAlignment="Center"
											   Margin="0,8,0,0"/>
								</Grid>
							</StackPanel>
						</Border>

						<!-- Empty State -->
						<Border Background="{StaticResource TertiaryDarkBrush}"
								CornerRadius="6"
								Padding="20"
								Visibility="{Binding HasActiveVAE, Converter={StaticResource InvertBool}}">
							<StackPanel HorizontalAlignment="Center">
								<TextBlock Text="âš¡"
										   FontSize="32"
										   HorizontalAlignment="Center"
										   Foreground="{StaticResource TextDisabledBrush}"
										   Margin="0,0,0,8"/>
								<TextBlock Text="No VAE Loaded"
										   HorizontalAlignment="Center"
										   Style="{StaticResource BodyTextStyle}"
										   FontSize="13"
										   FontWeight="Medium"/>
								<TextBlock Text="Using default encoder - load a VAE for enhanced quality"
										   HorizontalAlignment="Center"
										   Style="{StaticResource CaptionTextStyle}"
										   FontSize="11"
										   TextWrapping="Wrap"
										   TextAlignment="Center"
										   Margin="0,4,0,0"/>
							</StackPanel>
						</Border>
					</StackPanel>
				</ScrollViewer>

				<!-- VAE Stats -->
				<Border Grid.Row="2"
						Background="{StaticResource TertiaryDarkBrush}"
						CornerRadius="6"
						Padding="12,8"
						Margin="0,16,0,0">
					<Grid>
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="*"/>
							<ColumnDefinition Width="*"/>
						</Grid.ColumnDefinitions>

						<StackPanel Grid.Column="0">
							<TextBlock Text="Available"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
							<TextBlock Text="{Binding TotalVAEsCount}"
									   Style="{StaticResource HeadingMediumStyle}"
									   FontSize="16"/>
						</StackPanel>

						<StackPanel Grid.Column="1">
							<TextBlock Text="Status"
									   Style="{StaticResource CaptionTextStyle}"
									   FontSize="10"/>
							<TextBlock Text="{Binding HasActiveVAE, Converter={StaticResource BoolToStatusConverter}}"
									   Style="{StaticResource HeadingMediumStyle}"
									   FontSize="16"/>
						</StackPanel>
					</Grid>
				</Border>
			</Grid>
		</Border>
	</Grid>
</UserControl>